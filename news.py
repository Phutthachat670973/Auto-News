import os          # ‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° (env) ‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå/‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
import re          # ‡πÇ‡∏°‡∏î‡∏π‡∏• regex ‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏° pattern
import json        # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ-‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Python object <-> JSON string
import time        # ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô sleep ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
import random      # ‡πÉ‡∏ä‡πâ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API)
from datetime import datetime, timedelta   # ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏≤‡∏™ datetime ‡πÅ‡∏•‡∏∞ timedelta ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
from urllib.parse import urlparse, urlunparse, parse_qsl, urlencode  # ‡πÅ‡∏¢‡∏Å/‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞ query string

import feedparser   # ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏≠‡πà‡∏≤‡∏ô RSS feed ‡∏Ç‡πà‡∏≤‡∏ß ‚Üí ‡πÅ‡∏õ‡∏•‡∏á RSS ‡πÄ‡∏õ‡πá‡∏ô object ‡∏ó‡∏µ‡πà‡∏ß‡∏ô loop ‡πÑ‡∏î‡πâ
from dateutil import parser as dateutil_parser  # ‡∏ä‡πà‡∏ß‡∏¢ parse string ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô datetime
import pytz         # ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ timezone (‡πÄ‡∏ä‡πà‡∏ô Asia/Bangkok)
import requests     # ‡πÉ‡∏ä‡πâ‡∏¢‡∏¥‡∏á HTTP request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏£‡∏∑‡∏≠ API ‡∏ï‡πà‡∏≤‡∏á ‡πÜ

# ===== ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å .env (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) =====
# ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .env (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ô‡πÉ‡∏ô local)
#   - .env ‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏ß‡∏Å secret ‡∏´‡∏£‡∏∑‡∏≠ config ‡πÄ‡∏ä‡πà‡∏ô LINE_ACCESS_TOKEN, DRY_RUN, OLLAMA_MODEL
#   - ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡πá‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ô environment ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå .env)
try:
    from dotenv import load_dotenv
    load_dotenv()
except Exception:
    pass

# ========================= CONFIG =========================
# ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ ‚Äú‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‚Äù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° ‡πÄ‡∏ä‡πà‡∏ô token, timeout, limit ‡∏ï‡πà‡∏≤‡∏á ‡πÜ

# ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ LINE_CHANNEL_ACCESS_TOKEN ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏¥‡∏á Broadcast ‡πÑ‡∏õ LINE
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN", "").strip()

# ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ LINE_CHANNEL_ACCESS_TOKEN ‚Üí ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡πà‡∏á LINE ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
if not LINE_CHANNEL_ACCESS_TOKEN:
    raise RuntimeError("‡πÑ‡∏°‡πà‡∏û‡∏ö LINE_CHANNEL_ACCESS_TOKEN ‡πÉ‡∏ô Environment/Secrets")

# ---------- LLM CONFIG (Llama ‡∏ú‡πà‡∏≤‡∏ô Ollama) ----------
# URL ‡∏Ç‡∏≠‡∏á Ollama API (‡∏Ñ‡πà‡∏≤ default ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏±‡∏ô‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
OLLAMA_URL = os.getenv("OLLAMA_URL", "http://localhost:11434/api/generate").strip() or "http://localhost:11434/api/generate"

# ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏• Llama ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ (‡πÄ‡∏ä‡πà‡∏ô llama3.1:8b ‡∏´‡∏£‡∏∑‡∏≠ llama3.2:3b)
OLLAMA_MODEL = os.getenv("OLLAMA_MODEL", "llama3.1:8b").strip() or "llama3.1:8b"

# ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ retry ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏à‡∏≠ error ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
MAX_RETRIES = int(os.getenv("LLM_MAX_RETRIES", "6"))

# ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ delay ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á
#   - ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ spam LLM (‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ script ‡∏¢‡∏¥‡∏á‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô)
SLEEP_BETWEEN_CALLS = (
    float(os.getenv("LLM_SLEEP_MIN", "2.0")),
    float(os.getenv("LLM_SLEEP_MAX", "3.0")),
)

# ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á DRY_RUN = "true" ‡πÉ‡∏ô env:
#   - ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏∞ ‚Äú‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á‚Äù LINE Broadcast ‡∏à‡∏£‡∏¥‡∏á
#   - ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÅ‡∏Ñ‡πà print payload ‡∏≠‡∏≠‡∏Å console ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
DRY_RUN = os.getenv("DRY_RUN", "false").lower() == "true"

# ‡∏ï‡∏±‡πâ‡∏á timezone ‡πÄ‡∏õ‡πá‡∏ô Asia/Bangkok (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
bangkok_tz = pytz.timezone("Asia/Bangkok")

# now = ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏ì ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
#   - ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå, log, ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
now = datetime.now(bangkok_tz)

# ‡πÉ‡∏ä‡πâ requests.Session ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ requests.get/post ‡∏ï‡∏£‡∏á ‡πÜ
#   - Session ‡∏à‡∏∞ reuse ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ HTTP ‡πÄ‡∏î‡∏¥‡∏° ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏≤‡∏¢ ‡πÜ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏Å‡∏ß‡πà‡∏≤
S = requests.Session()

# ‡∏ï‡∏±‡πâ‡∏á header User-Agent ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô browser ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
#   - ‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏∞ block ‡∏ñ‡πâ‡∏≤ User-Agent ‡πÅ‡∏õ‡∏•‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
S.headers.update({"User-Agent": "Mozilla/5.0"})

# ‡∏ï‡∏±‡πâ‡∏á timeout ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ß‡πá‡∏ö (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
#   - ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö
TIMEOUT = 15

# ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö ‚Äú‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô
#   - ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ã‡πâ‡∏≥ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ + ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô)
SENT_LINKS_DIR = "sent_links"

# ‡∏ñ‡πâ‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏•‡∏¢
os.makedirs(SENT_LINKS_DIR, exist_ok=True)

# ========================= LLM Helper (Llama/Ollama) =========================
def call_llama(prompt: str, max_retries: int = MAX_RETRIES) -> str:
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Llama ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô Ollama (‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå)
    - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ API key
    - ‡∏¢‡∏¥‡∏á HTTP POST ‡πÑ‡∏õ‡∏ó‡∏µ‡πà OLLAMA_URL ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö (string)
    """
    payload = {
        "model": OLLAMA_MODEL,
        "prompt": prompt,
        "stream": False,  # ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏õ‡πá‡∏ô stream
    }

    last_error = None
    for attempt in range(1, max_retries + 1):
        try:
            r = S.post(OLLAMA_URL, json=payload, timeout=TIMEOUT)
            r.raise_for_status()
            data = r.json()
            # ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á Ollama ‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ:
            # {
            #   "model": "...",
            #   "created_at": "...",
            #   "response": "...",
            #   "done": true,
            #   ...
            # }
            return (data.get("response") or "").strip()
        except Exception as e:
            last_error = e
            print(f"[LLM ERROR] attempt {attempt}:", e)
            if attempt < max_retries:
                # ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö backoff ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                time.sleep(min(60, 3 * attempt))
            else:
                # ‡∏•‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡∏±‡∏á error ‚Üí ‡πÇ‡∏¢‡∏ô error ‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                raise last_error

def call_llm_text(prompt: str, max_retries: int = MAX_RETRIES) -> str:
    """
    Wrapper ‡∏ö‡∏≤‡∏á ‡πÜ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡∏•‡∏±‡∏ö backend (‡πÄ‡∏ä‡πà‡∏ô Llama/Groq/‡∏Ø‡∏•‡∏Ø)
    ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Llama ‡∏ú‡πà‡∏≤‡∏ô Ollama ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    """
    return call_llama(prompt, max_retries=max_retries)

# ========================= Helpers =========================
def _normalize_link(url: str) -> str:
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‚Äú‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î URL‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
    ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:
      - ‡∏•‡∏ö query ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ß‡∏Å tracking (utm_*, fbclid, gclid ‡∏Ø‡∏•‡∏Ø)
      - normalize scheme (‡πÄ‡∏ä‡πà‡∏ô http/https) ‡πÅ‡∏•‡∏∞ netloc (‡πÇ‡∏î‡πÄ‡∏°‡∏ô) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å
      - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå ‚Äú‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‚Äù ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
    ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
      https://example.com/news?id=1&utm_source=fb
      ‚Üí https://example.com/news?id=1
    """
    try:
        # ‡πÅ‡∏¢‡∏Å URL ‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô ‡πÜ (scheme, netloc, path, query ‡∏Ø‡∏•‡∏Ø)
        p = urlparse(url)
        netloc = p.netloc.lower()              # ‡∏ó‡∏≥‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å
        scheme = (p.scheme or "https").lower() # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ scheme ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "https" ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ default

        # ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ query param ‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏Ç‡∏¢‡∏∞ tracking" ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß
        bad_keys = {"fbclid", "gclid", "ref", "ref_", "mc_cid", "mc_eid"}

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á list ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á query ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
        q = []
        for k, v in parse_qsl(p.query, keep_blank_values=True):
            # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ß‡∏Å utm_* ‡∏´‡∏£‡∏∑‡∏≠ key ‡πÉ‡∏ô bad_keys ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á
            if k.startswith("utm_") or k in bad_keys:
                continue
            # ‡∏ô‡∏≠‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
            q.append((k, v))

        # ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö URL ‡∏Å‡∏•‡∏±‡∏ö ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ scheme/netloc ‡∏ó‡∏µ‡πà normalize ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞ query ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á
        return urlunparse(p._replace(scheme=scheme, netloc=netloc, query=urlencode(q)))
    except Exception:
        # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error ‡πÉ‡∏î ‡πÜ (‡πÄ‡∏ä‡πà‡∏ô url ‡πÅ‡∏õ‡∏•‡∏Å‡∏°‡∏≤‡∏Å) ‚Üí ‡∏Ñ‡∏∑‡∏ô string ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢
        return (url or "").strip()


def get_sent_links_file(date=None):
    """
    ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö ‚Äú‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô ‡πÜ
    ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: sent_links/YYYY-MM-DD.txt

    - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á date ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‚Üí ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
    - 1 ‡∏ß‡∏±‡∏ô = 1 ‡πÑ‡∏ü‡∏•‡πå
    """
    if date is None:
        date = datetime.now(bangkok_tz).strftime("%Y-%m-%d")
    return os.path.join(SENT_LINKS_DIR, f"{date}.txt")


def load_sent_links_today_yesterday():
    """
    ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô:
      - ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô

    ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:
      - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 2 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

    ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:
      - ‡∏ß‡∏ô i = 0,1 ‚Üí ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
      - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
      - normalize URL ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‚Üí ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á set
    """
    sent_links = set()
    for i in range(2):
        date = (now - timedelta(days=i)).strftime("%Y-%m-%d")
        path = get_sent_links_file(date)

        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                for line in f:
                    url = _normalize_link(line.strip())
                    if url:
                        sent_links.add(url)

    return sent_links


def save_sent_links(new_links, date=None):
    """
    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
    - ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö load_sent_links_today_yesterday ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
    """
    path = get_sent_links_file(date)
    with open(path, "a", encoding="utf-8") as f:
        for url in new_links:
            f.write(_normalize_link(url) + "\n")


def _polish_impact_text(text: str) -> str:
    """
    ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô impact_reason ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á:
      - ‡∏•‡∏ö‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ (‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö/‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô/‡∏™‡∏±‡πâ‡∏ô/‡∏Å‡∏•‡∏≤‡∏á/‡∏¢‡∏≤‡∏ß) ‡∏≠‡∏≠‡∏Å
        (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ LLM ‡πÉ‡∏™‡πà meta ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö)
      - ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≥ ‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      - ‡πÅ‡∏Å‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î (", ," ‡∏´‡∏£‡∏∑‡∏≠ ", .") ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
    """
    if not text:
        return text

    # ‡∏•‡∏ö‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ö‡∏≠‡∏Å‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß/‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö
    text = re.sub(r"\((?:[^)]*(?:‡∏ö‡∏ß‡∏Å|‡∏•‡∏ö|‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô|‡∏™‡∏±‡πâ‡∏ô|‡∏Å‡∏•‡∏≤‡∏á|‡∏¢‡∏≤‡∏ß)[^)]*)\)", "", text)
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏ï‡∏±‡∏ß ‚Üí ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    text = re.sub(r"\s{2,}", " ", text)
    # ‡πÅ‡∏Å‡πâ‡πÄ‡∏Ñ‡∏™ , , ‚Üí , 
    text = re.sub(r"\s*,\s*,", ", ", text)
    # ‡πÅ‡∏Å‡πâ‡πÄ‡∏Ñ‡∏™ , . ‚Üí .
    text = re.sub(r"\s*,\s*\.", ".", text)
    return text.strip()

# ========================= FEEDS =========================
# ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ RSS feed ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß
# - ‡πÅ‡∏ï‡πà‡∏•‡∏∞ key ‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ source ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏≠‡∏á
# - ‡πÄ‡∏Å‡πá‡∏ö URL, ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏ç‡πà ‡πÜ, ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠ site ‡πÑ‡∏ß‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô LINE
news_sources = {
    "Oilprice": {
        "url": "https://oilprice.com/rss/main",
        "category": "Energy",
        "site": "Oilprice"
    },
    "CleanTechnica": {
        "url": "https://cleantechnica.com/feed/",
        "category": "Energy",
        "site": "CleanTechnica"
    },
    "HydrogenFuelNews": {
        "url": "https://www.hydrogenfuelnews.com/feed/",
        "category": "Energy",
        "site": "Hydrogen Fuel News"
    },
    "Economist": {
        "url": "https://www.economist.com/latest/rss.xml",
        "category": "Economy",
        "site": "Economist"
    },
    "YahooFinance": {
        "url": "https://finance.yahoo.com/news/rssindex",
        "category": "Economy",
        "site": "Yahoo Finance"
    },
}

# URL ‡∏£‡∏π‡∏õ default (‡∏™‡∏≥‡∏£‡∏≠‡∏á) ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
DEFAULT_ICON_URL = "https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png"

# regex ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏•‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô ":" ‡∏õ‡∏Å‡∏ï‡∏¥
#   - ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà LLM ‡∏ï‡∏≠‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ Unicode ‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ
COLON_RX = re.compile(r"[ÔºöÔπïÍûâÔ∏ì‚¶Ç‚∏øÀ∏]")


def _normalize_colons(text: str) -> str:
    """
    ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ":" ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ (fullwidth/‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô ‡∏Ø‡∏•‡∏Ø)
    ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ":" ASCII ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    """
    return COLON_RX.sub(":", text or "")


def fetch_article_image(url: str) -> str:
    """
    ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° "‡∏î‡∏∂‡∏á URL ‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß" ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á
    ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏≤:
      1) meta property="og:image"
      2) meta name="twitter:image"
      3) src ‡∏Ç‡∏≠‡∏á <img> ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß
    ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‚Üí ‡∏Ñ‡∏∑‡∏ô string ‡∏ß‡πà‡∏≤‡∏á ""
    """
    try:
        # ‡∏¢‡∏¥‡∏á HTTP GET ‡πÑ‡∏õ‡∏î‡∏∂‡∏á HTML ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        r = S.get(url, timeout=TIMEOUT)
        if r.status_code >= 400:
            # ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (4xx/5xx) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ parse ‡∏ï‡πà‡∏≠
            return ""
        html = r.text

        # 1) ‡∏´‡∏≤ meta og:image
        m = re.search(
            r'<meta[^>]+property=[\'\"]og:image[\'\"][^>]+content=[\'\"]([^\'\"]+)[\'\"]',
            html,
            re.I
        )
        if m:
            return m.group(1)

        # 2) ‡∏´‡∏≤ meta twitter:image
        m = re.search(
            r'<meta[^>]+name=[\'\"]twitter:image[\'\"][^>]+content=[\'\"]([^\'\"]+)[\'\"]',
            html,
            re.I
        )
        if m:
            return m.group(1)

        # 3) ‡∏´‡∏≤ <img> ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏à‡∏≤‡∏Å HTML
        m = re.search(r'<img[^>]+src=[\'\"]([^\'\"]+)[\'\"]', html, re.I)
        if m:
            src = m.group(1)
            # ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ // ‚Üí ‡πÉ‡∏™‡πà scheme ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏ä‡πà‡∏ô https:)
            if src.startswith("//"):
                parsed = urlparse(url)
                return f"{parsed.scheme}:{src}"
            # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô path ‡πÅ‡∏ö‡∏ö /xxx ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏ï‡∏≤‡∏° URL ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á
            if src.startswith("/"):
                parsed = urlparse(url)
                return f"{parsed.scheme}://{parsed.netloc}{src}"
            # ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô return ‡∏ï‡∏≤‡∏° src ‡∏ï‡∏£‡∏á ‡πÜ
            return src

        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢
        return ""
    except Exception:
        # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error (‡πÄ‡∏ä‡πà‡∏ô timeout, parse error) ‚Üí ‡∏Ñ‡∏∑‡∏ô "" ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡πÉ‡∏ä‡πâ DEFAULT_ICON_URL ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
        return ""

# ========================= Upstream & Gas Context =========================
# ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó PTT_CONTEXT:
#   - ‡πÉ‡∏ä‡πâ‡∏ù‡∏±‡∏á‡πÉ‡∏ô prompt ‡∏Ç‡∏≠‡∏á LLM ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô/‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß
#   - ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ value chain ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ
#   - ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏Å‡∏ì‡∏ë‡πå 4 ‡∏Ç‡πâ‡∏≠ ‡∏ß‡πà‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"
PTT_CONTEXT = """
[‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‚Äî ‡∏â‡∏ö‡∏±‡∏ö‡∏¢‡πà‡∏≠]

‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° value chain ‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û:
- ‡∏õ‡∏•‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏ô‡πâ‡∏≥: ‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏° (‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÇ‡∏î‡∏¢ PTTEP) ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ LNG ‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏à‡∏≤‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‚Üí ‡πÇ‡∏£‡∏á‡πÅ‡∏¢‡∏Å‡∏Å‡πä‡∏≤‡∏ã ‚Üí ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Å‡πä‡∏≤‡∏ã
- ‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏Ç‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡πä‡∏≤‡∏ã: ‡πÇ‡∏£‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πä‡∏≤‡∏ã‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á, ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°, ‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ, NGV ‡∏Ø‡∏•‡∏Ø
- ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á: 
  - PTTEP (Upstream)
  - PTTLNG (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö LNG)
  - PTTGL/‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏Å‡πä‡∏≤‡∏ã
  - PTTNGD (‡∏à‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏Å‡πä‡∏≤‡∏ã)
  - TTM (Trans Thai-Malaysia) ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏Å‡πä‡∏≤‡∏ã‡πÅ‡∏•‡∏∞‡πÇ‡∏£‡∏á‡πÅ‡∏¢‡∏Å‡∏Å‡πä‡∏≤‡∏ã‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‚Äì‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô 50:50 ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á PTT ‡∏Å‡∏±‡∏ö PETRONAS ‡∏î‡∏π‡πÅ‡∏•
    ‡∏ó‡πà‡∏≠‡∏Å‡πä‡∏≤‡∏ã Thai‚ÄìMalaysia Gas Pipeline ‡πÅ‡∏•‡∏∞ Thai‚ÄìMalaysia Gas Separation Plant ‡∏ó‡∏±‡πâ‡∏á‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢

‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ç‡πà‡∏≤‡∏ß "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó."
‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ:

1) ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏£‡∏á
   - ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏î‡∏¥‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πä‡∏≤‡∏ã/LNG ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
   - ‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á PTTEP ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ LNG/‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó.

2) ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡∏Å‡πä‡∏≤‡∏ã/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏∞‡∏î‡∏∏‡∏î
   - ‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏ú‡∏•‡∏¥‡∏ï/‡∏•‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï, ‡∏ó‡πà‡∏≠‡∏Å‡πä‡∏≤‡∏ã‡πÄ‡∏™‡∏µ‡∏¢, ‡πÇ‡∏£‡∏á‡πÅ‡∏¢‡∏Å‡∏Å‡πä‡∏≤‡∏ã‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠/FSRU ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
   - ‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô/‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°/‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡πä‡∏≤‡∏ã/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏•‡∏î‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô

3) ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏µ‡∏•‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏•‡∏≤‡∏î
   - ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡∏°‡πà, FID, M&A, ‡∏ó‡πà‡∏≠‡∏Å‡πä‡∏≤‡∏ã/‡πÇ‡∏£‡∏á‡πÅ‡∏¢‡∏Å/‡∏Ñ‡∏•‡∏±‡∏á LNG/‡πÇ‡∏£‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
   - ‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏£‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ

4) ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢/‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ê‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô
   - ‡∏†‡∏≤‡∏©‡∏µ, ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢, ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏Å‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à ‡∏ú‡∏•‡∏¥‡∏ï ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏¢‡∏Å‡πä‡∏≤‡∏ã/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô
   - ‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πä‡∏≤‡∏ã/‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó.

‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πà‡∏≤‡∏ß‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î downstream, PR, promotion, EV ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° supply‚Äìdemand ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô
‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö scope ‡∏ô‡∏µ‡πâ
"""

# ========================= Filter: ‡πÉ‡∏ä‡πà/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà =========================
def llm_ptt_subsidiary_impact_filter(news):
    """
    ‡πÉ‡∏ä‡πâ LLM (Llama ‡∏ú‡πà‡∏≤‡∏ô Ollama) ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤:
      ‚Äú‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö Upstream/‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡πä‡∏≤‡∏ã ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?‚Äù

    ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏≠‡∏ö:
      - ‡∏ñ‡πâ‡∏≤ LLM ‡∏ï‡∏≠‡∏ö "‡πÉ‡∏ä‡πà"  ‚Üí ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ True
      - ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà" ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î error ‚Üí ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ False

    news: dict ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢
      - title
      - summary
      - (option) detail
    """
    prompt = f'''
{PTT_CONTEXT}

‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "News Screener" ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‡∏î‡πâ‡∏≤‡∏ô‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥

‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏°‡∏µ‡πÅ‡∏Ñ‡πà 2 ‡∏Ñ‡∏≥‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
- "‡πÉ‡∏ä‡πà"    = ‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö Upstream ‡∏´‡∏£‡∏∑‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå 4 ‡∏Ç‡πâ‡∏≠
- "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà" = ‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô downstream/PR/‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô

‡∏Ç‡πà‡∏≤‡∏ß:
‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: {news['title']}
‡∏™‡∏£‡∏∏‡∏õ: {news['summary']}
‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {news.get('detail','')}

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: "‡πÉ‡∏ä‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà"
'''
    try:
        ans = (call_llm_text(prompt) or "").strip().replace("\n", "")
        return ans.startswith("‡πÉ‡∏ä‡πà")
    except Exception as e:
        print("[ERROR] LLM Filter:", e)
        return False

# ========================= Tag ‡∏Ç‡πà‡∏≤‡∏ß =========================
def llm_tag_news(news):
    """
    ‡πÉ‡∏ä‡πâ LLM ‡πÄ‡∏û‡∏∑‡πà‡∏≠:
      - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
      - ‡∏ï‡∏¥‡∏î tag ‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡πÉ‡∏î‡∏ö‡πâ‡∏≤‡∏á (PTTEP / PTTLNG / PTTGL / PTTNGD / TTM)
      - ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πà‡∏≤‡∏ß (topic_type)
      - ‡∏£‡∏∞‡∏ö‡∏∏ region ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (global / asia / us ... )
      - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô impact_reason (‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó.)

    ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤:
      - dict JSON ‡∏ï‡∏≤‡∏° schema ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    """
    # schema ‡∏Å‡∏≥‡∏´‡∏ô‡∏î structure ‡∏Ç‡∏≠‡∏á JSON ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ LLM ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    schema = {
        "type": "object",
        "properties": {
            "summary": {"type": "string"},  # ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            "impact_companies": {
                "type": "array",
                "items": {
                    "type": "string",
                    "enum": ["PTTEP", "PTTLNG", "PTTGL", "PTTNGD", "TTM"]
                }
            },
            "topic_type": {
                "type": "string",
                "enum": [
                    "supply_disruption",
                    "price_move",
                    "policy",
                    "investment",
                    "geopolitics",
                    "other"
                ]
            },
            "region": {
                "type": "string",
                "enum": [
                    "global",
                    "asia",
                    "europe",
                    "middle_east",
                    "us",
                    "other"
                ]
            },
            "impact_reason": {"type": "string"}
        },
        "required": ["summary", "impact_companies", "topic_type", "region", "impact_reason"]
    }

    prompt = f"""
{PTT_CONTEXT}

‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: Analyst ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥)
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: "‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏Å" ‡∏ï‡∏≤‡∏° value chain ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏ì‡∏ë‡πå 4 ‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô

‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡∏Ç‡πà‡∏≤‡∏ß:
‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: {news['title']}
‡∏™‡∏£‡∏∏‡∏õ (‡∏à‡∏≤‡∏Å RSS): {news['summary']}
‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {news.get('detail','')}

‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤:
- ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô summary ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
- ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô impact_reason ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
- ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞/‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° schema ‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
{json.dumps(schema, ensure_ascii=False)}

‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ field ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠:
- summary: ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏Å‡πä‡∏≤‡∏ã/‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£ (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
- impact_companies: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 0‚Äì2 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏≤‡∏Å ["PTTEP","PTTLNG","PTTGL","PTTNGD","TTM"]
- topic_type: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πà‡∏≤‡∏ß (price_move, policy ‡∏Ø‡∏•‡∏Ø)
- region: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (global, asia, us ‡∏Ø‡∏•‡∏Ø)
- impact_reason: ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ß‡πà‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏´‡∏ô (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)

‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å JSON ‡∏ï‡∏≤‡∏° schema
"""

    try:
        raw = (call_llm_text(prompt) or "").strip()

        # ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ LLM ‡πÉ‡∏™‡πà ```json ... ``` ‡∏Ñ‡∏£‡∏≠‡∏ö‡πÑ‡∏ß‡πâ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢ json.loads
        if raw.startswith("```"):
            raw = re.sub(r"^```(json)?", "", raw).strip()
            raw = re.sub(r"```$", "", raw).strip()

        data = json.loads(raw)
        return data

    except Exception as e:
        print("[WARN] JSON parse fail in llm_tag_news:", e)
        # ‡∏ñ‡πâ‡∏≤ parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Üí ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ fallback ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        return {
            "summary": news.get("summary") or news.get("title") or "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ",
            "impact_companies": [],
            "topic_type": "other",
            "region": "other",
            "impact_reason": "fallback ‚Äì ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å RSS ‡πÅ‡∏ó‡∏ô"
        }

# ========================= Logic =========================
def is_ptt_related_from_output(impact_companies) -> bool:
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤:
      - ‡∏ñ‡πâ‡∏≤ impact_companies ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö PTT
      - ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
    """
    return bool(impact_companies)


def fetch_news_9pm_to_6am():
    """
    ‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏à‡∏≤‡∏Å RSS ‡∏ó‡∏∏‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:
      - 21:00 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
      - ‡∏ñ‡∏∂‡∏á 06:00 ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)

    ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:
      1) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î start_time / end_time ‡∏ï‡∏≤‡∏° timezone ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
      2) ‡∏ß‡∏ô‡∏ó‡∏∏‡∏Å source ‡πÉ‡∏ô news_sources
         - ‡πÉ‡∏ä‡πâ feedparser.parse(url) ‡∏î‡∏∂‡∏á feed
         - loop feed.entries
            - ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏Ç‡πà‡∏≤‡∏ß (published/updated) ‚Üí datetime
            - ‡πÅ‡∏õ‡∏•‡∏á timezone ‡πÄ‡∏õ‡πá‡∏ô Asia/Bangkok
            - ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‚Üí ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á all_news
      3) ‡∏•‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ã‡πâ‡∏≥‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏à‡∏≤‡∏Å URL ‡∏ó‡∏µ‡πà normalize ‡πÅ‡∏•‡πâ‡∏ß
      4) ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ list ‡∏Ç‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
    """
    # ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ) ‡∏ï‡∏≤‡∏° timezone ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
    now_local = datetime.now(bangkok_tz)

    # start_time: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô 21:00
    start_time = (now_local - timedelta(days=1)).replace(
        hour=21, minute=0, second=0, microsecond=0
    )

    # end_time: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ 06:00
    end_time = now_local.replace(
        hour=6, minute=0, second=0, microsecond=0
    )

    all_news = []

    for _, info in news_sources.items():
        try:
            feed = feedparser.parse(info["url"])

            for entry in feed.entries:
                pub_str = getattr(entry, "published", None) or getattr(entry, "updated", None)

                if not pub_str and getattr(entry, "published_parsed", None):
                    t = entry.published_parsed
                    pub_dt = datetime(*t[:6], tzinfo=pytz.UTC).astimezone(bangkok_tz)
                else:
                    if not pub_str:
                        continue
                    pub_dt = dateutil_parser.parse(pub_str)
                    if pub_dt.tzinfo is None:
                        pub_dt = pytz.UTC.localize(pub_dt)
                    pub_dt = pub_dt.astimezone(bangkok_tz)

                if not (start_time <= pub_dt <= end_time):
                    continue

                summary = getattr(entry, "summary", "") or getattr(entry, "description", "")
                link = getattr(entry, "link", "")
                title = getattr(entry, "title", "-")

                all_news.append({
                    "site": info["site"],
                    "category": info["category"],
                    "title": title,
                    "summary": summary,
                    "link": link,
                    "published": pub_dt,
                    "date": pub_dt.strftime("%d/%m/%Y %H:%M"),
                })
        except Exception as e:
            print(f"[WARN] ‡∏≠‡πà‡∏≤‡∏ô‡∏ü‡∏µ‡∏î {info['site']} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: {e}")

    # ‡∏•‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ã‡πâ‡∏≥: ‡πÉ‡∏ä‡πâ URL ‡∏´‡∏•‡∏±‡∏á normalize ‡πÄ‡∏õ‡πá‡∏ô key
    seen, uniq = set(), []
    for n in all_news:
        key = _normalize_link(n.get("link", ""))
        if key and key not in seen:
            seen.add(key)
            uniq.append(n)

    return uniq

# --------- Coverage-first selection ----------
KEY_COMPANIES = ["PTTEP", "PTTLNG", "PTTGL", "PTTNGD", "TTM"]
KEY_TOPICS = ["supply_disruption", "price_move", "policy", "investment", "geopolitics"]


def select_news_coverage_first(news_list, max_items=10):
    """
    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πà‡∏≤‡∏ß/‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î "coverage-first":
      1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏ô KEY_COMPANIES ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°
      2) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó KEY_TOPICS ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
      3) ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô max_items ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà ‡πÜ ‡∏•‡∏á‡πÑ‡∏õ‡∏à‡∏ô‡∏Ñ‡∏£‡∏ö
    """
    if not news_list:
        return []

    sorted_news = sorted(news_list, key=lambda n: n.get("published"), reverse=True)

    selected = []
    used_ids = set()

    def _add_if_not_selected(candidate):
        key = _normalize_link(candidate.get("link", "")) or id(candidate)
        if key in used_ids:
            return False
        if len(selected) >= max_items:
            return False
        selected.append(candidate)
        used_ids.add(key)
        return True

    # ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
    for comp in KEY_COMPANIES:
        if len(selected) >= max_items:
            break
        for n in sorted_news:
            companies = n.get("ptt_companies") or []
            if comp in companies:
                if _add_if_not_selected(n):
                    break

    # ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ó‡∏∏‡∏Å topic_type ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    for topic in KEY_TOPICS:
        if len(selected) >= max_items:
            break
        if any((x.get("topic_type") == topic) for x in selected):
            continue
        for n in sorted_news:
            if n.get("topic_type") == topic:
                if _add_if_not_selected(n):
                    break

    # ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà ‡πÜ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö max_items
    for n in sorted_news:
        if len(selected) >= max_items:
            break
        _add_if_not_selected(n)

    return selected

# --------- Grouping ‡∏Ç‡πà‡∏≤‡∏ß‡∏ï‡∏≤‡∏° topic + region ----------
def group_related_news(news_list, min_group_size=3):
    """
    ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà (topic_type, region)
      - ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏´‡∏ô‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß >= min_group_size ‚Üí ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß" (is_group=True)
      - ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Üí ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
    """
    buckets = {}

    for n in news_list:
        key = (n.get("topic_type", "other"), n.get("region", "other"))
        buckets.setdefault(key, []).append(n)

    grouped_items = []

    for (topic, region), items in buckets.items():
        if len(items) >= min_group_size:
            all_companies = []
            for it in items:
                all_companies.extend(it.get("ptt_companies") or [])
            all_companies = list(dict.fromkeys(all_companies))

            items_sorted = sorted(items, key=lambda x: x.get("published"), reverse=True)
            anchor = items_sorted[0]

            group_obj = {
                "is_group": True,
                "topic_type": topic,
                "region": region,
                "ptt_companies": all_companies,
                "news_items": items_sorted,
                "title": anchor.get("title", "-"),
                "site": "‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß",
                "category": anchor.get("category", ""),
                "date": anchor.get("date", ""),
                "published": anchor.get("published"),
                "link": anchor.get("link", ""),
            }
            grouped_items.append(group_obj)
        else:
            grouped_items.extend(items)

    return grouped_items

def llm_summarize_group(group):
    """
    ‡πÉ‡∏ä‡πâ LLM ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß" ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô topic/region ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    ‡∏Ñ‡∏∑‡∏ô:
      - dict: { "summary": "...", "impact_reason": "..." } ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    """
    items = group.get("news_items", [])
    if not items:
        return {
            "summary": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°",
            "impact_reason": "-"
        }

    lines = []
    for idx, n in enumerate(items, 1):
        line = f"{idx}. {n.get('title','-')} ‚Äî {n.get('summary','')}"
        lines.append(line)
    news_block = "\n".join(lines)

    prompt = f"""
{PTT_CONTEXT}

‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: Analyst ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°" ‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ

‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß (‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡πà‡∏≠‡∏¢):
{news_block}

‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤:
- ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô summary ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
- ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô impact_reason ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
- ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÑ‡∏î‡πâ
- ‡πÅ‡∏ï‡πà‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏•‡πâ‡∏ß‡∏ô

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
{{
  "summary": "<‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° 3‚Äì5 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)>",
  "impact_reason": "<‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡πà‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‡∏ú‡πà‡∏≤‡∏ô upstream/gas ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)>"
}}

‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å JSON ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô
"""

    try:
        raw = (call_llm_text(prompt) or "").strip()

        if raw.startswith("```"):
            raw = re.sub(r"^```(json)?", "", raw).strip()
            raw = re.sub(r"```$", "", raw).strip()

        data = json.loads(raw)
        return data
    except Exception as e:
        print("[WARN] JSON parse fail in llm_summarize_group:", e)
        return {
            "summary": "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ",
            "impact_reason": "-"
        }

# --------- Labels & Human-friendly text ----------
TOPIC_LABELS_TH = {
    "supply_disruption": "Supply ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á/‡∏•‡∏î‡∏•‡∏á",
    "price_move": "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏Å‡πä‡∏≤‡∏ã‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô",
    "policy": "‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢/‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢",
    "investment": "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô/M&A",
    "geopolitics": "‡∏†‡∏π‡∏°‡∏¥‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå/‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°",
    "other": "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Upstream/‡∏Å‡πä‡∏≤‡∏ã",
}

REGION_LABELS_TH = {
    "global": "Global",
    "asia": "Asia",
    "europe": "Europe",
    "middle_east": "Middle East",
    "us": "US",
    "other": "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ",
}

HUMAN_TOPIC_EXPLANATION = {
    "price_move": "‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡πä‡∏≤‡∏ã ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á PTTEP ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Å‡πä‡∏≤‡∏ã/LNG ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó.",
    "supply_disruption": "‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏ú‡∏•‡∏¥‡∏ï ‡∏ó‡πà‡∏≠‡∏Å‡πä‡∏≤‡∏ã‡πÄ‡∏™‡∏µ‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡πä‡∏≤‡∏ã/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏•‡∏î‡∏•‡∏á",
    "investment": "‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏µ‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏ô‡∏´‡πà‡∏ß‡∏á‡πÇ‡∏ã‡πà‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô",
    "policy": "‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢ ‡∏†‡∏≤‡∏©‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ",
    "geopolitics": "‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏†‡∏π‡∏°‡∏¥‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏•‡∏≤‡∏î‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô",
    "other": "‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°",
}


def create_flex_message(news_items):
    """
    ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß (‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß/‡∏Å‡∏•‡∏∏‡πà‡∏°) ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£ tag + ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡πâ‡∏ß
    ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô Flex Message ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö carousel ‡∏Ç‡∏≠‡∏á LINE
    """
    now_thai = datetime.now(bangkok_tz).strftime("%d/%m/%Y")

    def join_companies(codes):
        codes = codes or []
        return ", ".join(codes) if codes else "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏∏"

    bubbles = []

    for item in news_items:
        img = item.get("image") or DEFAULT_ICON_URL
        if not (str(img).startswith("http://") or str(img).startswith("https://")):
            img = DEFAULT_ICON_URL

        topic_key = item.get("topic_type", "other")
        region_key = item.get("region", "other")
        topic_label = TOPIC_LABELS_TH.get(topic_key, "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ")
        region_label = REGION_LABELS_TH.get(region_key, "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ")
        human_note = HUMAN_TOPIC_EXPLANATION.get(topic_key, HUMAN_TOPIC_EXPLANATION["other"])

        impact_line = {
            "type": "text",
            "text": f"‡∏Å‡∏£‡∏∞‡∏ó‡∏ö: {join_companies(item.get('ptt_companies'))}",
            "size": "xs",
            "color": "#000000",
            "weight": "bold",
            "wrap": True,
            "margin": "sm"
        }

        meta_line = {
            "type": "text",
            "text": f"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: {topic_label} | ‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ: {region_label}",
            "size": "xs",
            "color": "#555555",
            "wrap": True,
            "margin": "sm"
        }

        group_sublist_box = None
        if item.get("is_group"):
            sub_items = item.get("news_items", [])[:5]
            sub_lines = []
            for sub in sub_items:
                line = f"‚Ä¢ [{sub.get('site','')}] {sub.get('title','-')}"
                sub_lines.append(line)
            sub_text = "\n".join(sub_lines) if sub_lines else "-"

            group_sublist_box = {
                "type": "box",
                "layout": "vertical",
                "margin": "md",
                "contents": [
                    {
                        "type": "text",
                        "text": "‡∏Ç‡πà‡∏≤‡∏ß‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ:",
                        "size": "xs",
                        "weight": "bold",
                        "color": "#000000",
                        "wrap": True
                    },
                    {
                        "type": "text",
                        "text": sub_text,
                        "size": "xs",
                        "color": "#444444",
                        "wrap": True
                    }
                ]
            }

        title_text = item.get("title", "-")
        if item.get("is_group"):
            count_sub = len(item.get("news_items", []))
            title_text = f"{topic_label} ({region_label}) ‚Äì {count_sub} ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"

        body_contents = [
            {
                "type": "text",
                "text": title_text,
                "weight": "bold",
                "size": "lg",
                "wrap": True,
                "color": "#111111"
            },
            {
                "type": "box",
                "layout": "horizontal",
                "margin": "sm",
                "contents": [
                    {
                        "type": "text",
                        "text": f"üóì {item.get('date','-')}",
                        "size": "xs",
                        "color": "#aaaaaa",
                        "flex": 5
                    },
                    {
                        "type": "text",
                        "text": f"üìå {item.get('category','')}",
                        "size": "xs",
                        "color": "#888888",
                        "align": "end",
                        "flex": 5
                    }
                ]
            },
            {
                "type": "text",
                "text": f"üåç {item.get('site','')}",
                "size": "xs",
                "color": "#448AFF",
                "margin": "sm"
            },
            impact_line,
            meta_line,
            {
                "type": "text",
                # NOTE: ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ field ‡πÄ‡∏î‡∏¥‡∏° gemini_summary ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å Llama
                "text": item.get("gemini_summary") or "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß",
                "size": "md",
                "wrap": True,
                "margin": "md",
                "color": "#1A237E",
                "weight": "bold"
            },
            {
                "type": "text",
                "text": "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:",
                "size": "xs",
                "weight": "bold",
                "color": "#000000",
                "margin": "md",
                "wrap": True,
            },
            {
                "type": "text",
                "text": human_note,
                "size": "xs",
                "color": "#444444",
                "wrap": True,
            },
            {
                "type": "box",
                "layout": "vertical",
                "margin": "lg",
                "contents": [
                    {
                        "type": "text",
                        "text": "‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó.",
                        "weight": "bold",
                        "size": "lg",
                        "color": "#D32F2F"
                    },
                    {
                        "type": "text",
                        # NOTE: ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ field ‡πÄ‡∏î‡∏¥‡∏° gemini_reason ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å Llama
                        "text": (item.get("gemini_reason") or "-"),
                        "size": "md",
                        "wrap": True,
                        "color": "#C62828",
                        "weight": "bold"
                    },
                ]
            }
        ]

        if group_sublist_box:
            body_contents.append(group_sublist_box)

        bubble = {
            "type": "bubble",
            "size": "mega",
            "hero": {
                "type": "image",
                "url": img,
                "size": "full",
                "aspectRatio": "16:9",
                "aspectMode": "cover"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "spacing": "md",
                "contents": body_contents
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "spacing": "sm",
                "contents": [
                    {
                        "type": "text",
                        "text": "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö",
                        "size": "xs",
                        "color": "#FF0000",
                        "wrap": True,
                        "margin": "md"
                    },
                    {
                        "type": "button",
                        "style": "primary",
                        "color": "#1DB446",
                        "action": {
                            "type": "uri",
                            "label": "‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠",
                            "uri": item.get("link", "#")
                        }
                    }
                ]
            }
        }
        bubbles.append(bubble)

    carousels = []
    for i in range(0, len(bubbles), 10):
        carousels.append({
            "type": "flex",
            "altText": f"‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö ‡∏õ‡∏ï‡∏ó. {now_thai}",
            "contents": {
                "type": "carousel",
                "contents": bubbles[i:i+10]
            }
        })
    return carousels


def broadcast_flex_message(access_token, flex_carousels):
    """
    ‡∏™‡πà‡∏á Flex Message ‡∏≠‡∏≠‡∏Å LINE Broadcast:
      - ‡∏ñ‡πâ‡∏≤ DRY_RUN = True ‚Üí ‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏Ñ‡πà print payload ‡∏≠‡∏≠‡∏Å‡∏ó‡∏≤‡∏á console (‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
      - ‡∏ñ‡πâ‡∏≤ error (‡πÄ‡∏ä‡πà‡∏ô status_code >= 300) ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πà‡∏á carousel ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    """
    url = 'https://api.line.me/v2/bot/message/broadcast'
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {access_token}"
    }

    for idx, carousel in enumerate(flex_carousels, 1):
        payload = {"messages": [carousel]}

        if DRY_RUN:
            print(f"[DRY_RUN] Carousel #{idx}: {json.dumps(payload)[:500]}...")
            continue

        try:
            resp = S.post(url, headers=headers, json=payload, timeout=TIMEOUT)
            print(f"Broadcast #{idx} status:", resp.status_code, getattr(resp, "text", ""))

            if resp.status_code >= 300:
                break

            time.sleep(1.2)
        except Exception as e:
            print("[LINE ERROR]", e)
            break

# ========================= MAIN =========================
def main():
    """
    Workflow ‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ä‡πâ Llama ‡∏ú‡πà‡∏≤‡∏ô Ollama):

    1) ‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 21:00 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ‚Äì 06:00 ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    2) ‡πÉ‡∏ä‡πâ LLM ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡πà‡∏≤ "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á Upstream/Gas ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"
    3) ‡πÉ‡∏ä‡πâ LLM ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏Å + ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß + ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö
    4) ‡∏£‡∏ß‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà topic+region ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏û‡∏≠)
    5) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß ‚Üí ‡∏Ç‡∏≠ meta-summary ‡∏à‡∏≤‡∏Å LLM ‡πÄ‡∏û‡∏¥‡πà‡∏°
    6) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏ö‡∏ö coverage-first
    7) ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ã‡πâ‡∏≥ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ/‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô)
    8) ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
    9) ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡πÅ‡∏•‡∏∞ Broadcast ‡∏ó‡∏≤‡∏á LINE
    10) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
    """

    # 1) ‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    all_news = fetch_news_9pm_to_6am()
    print(f"‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ä‡πà‡∏ß‡∏á 21:00 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ‡∏ñ‡∏∂‡∏á 06:00 ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: {len(all_news)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")

    if not all_news:
        print("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πà‡∏≤‡∏ß")
        return

    SLEEP_MIN, SLEEP_MAX = SLEEP_BETWEEN_CALLS

    # 2) Filter: ‡πÉ‡∏ä‡πâ LLM ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á Upstream/Gas ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    filtered_news = []
    for news in all_news:
        news['detail'] = news['title'] if len((news.get('summary') or '')) < 50 else ''

        if llm_ptt_subsidiary_impact_filter(news):
            filtered_news.append(news)

        time.sleep(random.uniform(SLEEP_MIN, SLEEP_MAX))

    print(f"‡∏Ç‡πà‡∏≤‡∏ß‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á Upstream/Gas): {len(filtered_news)} ‡∏Ç‡πà‡∏≤‡∏ß")

    if not filtered_news:
        print("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á")
        return

    # 3) Tagging: ‡πÉ‡∏ä‡πâ LLM ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏£‡∏∏‡∏õ + ‡∏ï‡∏¥‡∏î tag
    tagged_news = []
    print(f"‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ LLM ‡∏ï‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏Å {len(filtered_news)} ‡∏Ç‡πà‡∏≤‡∏ß")

    for news in filtered_news:
        tag = llm_tag_news(news)

        news['gemini_summary'] = _normalize_colons(tag.get('summary', '')).strip() or '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß'

        companies = [c for c in (tag.get('impact_companies') or []) if c in {"PTTEP", "PTTLNG", "PTTGL", "PTTNGD", "TTM"}]
        news['ptt_companies'] = list(dict.fromkeys(companies))

        news['topic_type'] = tag.get('topic_type', 'other')
        news['region'] = tag.get('region', 'other')

        news['gemini_reason'] = _polish_impact_text(tag.get('impact_reason', '').strip()) or '-'

        if is_ptt_related_from_output(news['ptt_companies']):
            tagged_news.append(news)

        time.sleep(random.uniform(SLEEP_MIN, SLEEP_MAX))

    if not tagged_news:
        print("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠ PTT ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á")
        return

    # 4) Grouping
    collapsed_list = group_related_news(tagged_news, min_group_size=3)

    # 5) ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢ LLM
    for item in collapsed_list:
        if item.get("is_group"):
            data = llm_summarize_group(item)
            item["gemini_summary"] = _normalize_colons(data.get("summary", "")).strip()
            item["gemini_reason"] = _polish_impact_text(data.get("impact_reason", "").strip() or "-")

    # 6) Coverage-first selection
    top_news = select_news_coverage_first(collapsed_list, max_items=10)

    # 7) ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ã‡πâ‡∏≥
    sent_links = load_sent_links_today_yesterday()
    top_news_to_send = [n for n in top_news if _normalize_link(n.get('link', '')) not in sent_links]

    if not top_news_to_send:
        print("‡∏Ç‡πà‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ/‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß")
        return

    # 8) ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
    for item in top_news_to_send:
        img = fetch_article_image(item.get("link", "")) or ""
        if not (str(img).startswith("http://") or str(img).startswith("https://")):
            img = DEFAULT_ICON_URL
        item["image"] = img

    # 9) ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex ‡πÅ‡∏•‡πâ‡∏ß broadcast
    carousels = create_flex_message(top_news_to_send)
    broadcast_flex_message(LINE_CHANNEL_ACCESS_TOKEN, carousels)

    # 10) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
    save_sent_links([n.get("link", "") for n in top_news_to_send])
    print("‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô.")


if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print("[ERROR]", e)
