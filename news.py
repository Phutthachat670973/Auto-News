# ============================================================================================================
# IMPORT & ENV
# ============================================================================================================
import os
import re
import json
import time
import random
from datetime import datetime, timedelta
from urllib.parse import urlparse, urlunparse, parse_qsl, urlencode

import feedparser
from dateutil import parser as dateutil_parser
import pytz
import requests
import google.generativeai as genai

try:
    from dotenv import load_dotenv
    load_dotenv()
except Exception:
    pass

GEMINI_API_KEY = os.getenv("GEMINI_API_KEY", "").strip()
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN", "").strip()

if not GEMINI_API_KEY:
    raise RuntimeError("‡πÑ‡∏°‡πà‡∏û‡∏ö GEMINI_API_KEY")

if not LINE_CHANNEL_ACCESS_TOKEN:
    raise RuntimeError("‡πÑ‡∏°‡πà‡∏û‡∏ö LINE_CHANNEL_ACCESS_TOKEN")

genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel(os.getenv("GEMINI_MODEL_NAME", "gemini-2.5-flash"))

GEMINI_DAILY_BUDGET = int(os.getenv("GEMINI_DAILY_BUDGET", "250"))
MAX_RETRIES = 6

# ‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤ sleep ‡∏•‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
SLEEP_BETWEEN_CALLS = (2.0, 3.0)

DRY_RUN = os.getenv("DRY_RUN", "false").lower() == "true"

# ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏ï‡πà‡∏≠‡∏£‡∏±‡∏ô (‡∏Å‡∏±‡∏ô LLM ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô)
MAX_NEWS_PER_RUN = int(os.getenv("MAX_NEWS_PER_RUN", "80"))

bangkok_tz = pytz.timezone("Asia/Bangkok")
now = datetime.now(bangkok_tz)

S = requests.Session()
S.headers.update({"User-Agent": "Mozilla/5.0"})
TIMEOUT = 15

SENT_LINKS_DIR = "sent_links"
os.makedirs(SENT_LINKS_DIR, exist_ok=True)

# ‡∏£‡∏π‡∏õ default ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö hero ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á ‡πÜ
DEFAULT_ICON_URL = "https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png"

# ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LLM (‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡∏Å)
KEYWORD_SUBSTRINGS = [
    "gas",
    "natural gas",
    "lng",
    "liquefied natural gas",
    "pipeline",
    "lpg",
    "ngv",
    "fsru",
    "regasification",
    "gas field",
    "gas supply",
    "gas export",
    "gas import",
]


# ============================================================================================================
# HELPERS
# ============================================================================================================
def _normalize_link(url: str) -> str:
    try:
        p = urlparse(url)
        netloc = p.netloc.lower()
        scheme = (p.scheme or "https").lower()

        drop = {"fbclid", "gclid", "ref", "mc_cid", "mc_eid"}
        new_q = [
            (k, v)
            for k, v in parse_qsl(p.query, keep_blank_values=True)
            if not (k.startswith("utm_") or k in drop)
        ]

        return urlunparse(
            p._replace(
                scheme=scheme,
                netloc=netloc,
                query=urlencode(new_q),
            )
        )
    except Exception:
        return (url or "").strip()


def get_sent_links_file(date=None):
    if date is None:
        date = datetime.now(bangkok_tz).strftime("%Y-%m-%d")
    return os.path.join(SENT_LINKS_DIR, f"{date}.txt")


def load_sent_links():
    """
    ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á '‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    (‡πÑ‡∏°‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
    """
    sent = set()
    today_str = datetime.now(bangkok_tz).strftime("%Y-%m-%d")
    p = get_sent_links_file(today_str)

    if os.path.exists(p):
        with open(p, "r", encoding="utf-8") as f:
            for line in f:
                u = _normalize_link(line.strip())
                if u:
                    sent.add(u)

    return sent


def save_sent_links(links):
    p = get_sent_links_file()
    with open(p, "a", encoding="utf-8") as f:
        for l in links:
            f.write(_normalize_link(l) + "\n")


def _impact_to_bullets(text: str):
    """
    ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° impact_reason ‡πÄ‡∏õ‡πá‡∏ô list bullet ‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡πÜ:
    - ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å
    - ‡∏•‡∏ö‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‚Ä¢ * - ¬∑ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö 1. 2) ‡∏≠‡∏≠‡∏Å
    - ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏î‡∏≠‡∏Å‡∏à‡∏±‡∏ô‡∏´‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
    """
    if not text:
        return ["‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö"]

    lines = [l.strip() for l in text.splitlines() if l.strip()]
    if not lines:
        lines = [text.strip()]

    bullets = []
    for line in lines:
        s = line.strip()
        # ‡∏•‡∏ö bullet symbols ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤: ‚Ä¢ * - ¬∑ ‡∏Ø‡∏•‡∏Ø
        s = re.sub(r"^[\u2022\*\-\u00b7¬∑‚Ä¢\s]+", "", s)
        # ‡∏•‡∏ö‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô "1." "2)" "3 ." ‡∏≠‡∏≠‡∏Å
        s = re.sub(r"^\d+[\.\)]\s*", "", s)
        # ‡∏•‡∏ö‡∏î‡∏≠‡∏Å‡∏à‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏´‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ö‡∏ö ".* ..." ‡∏´‡∏£‡∏∑‡∏≠ "* ..."
        if s.startswith(".*"):
            s = s[2:].lstrip()
        if s.startswith("*"):
            s = s[1:].lstrip()
        if s:
            bullets.append(s)

    return bullets or ["‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö"]


def keyword_pre_filter(news):
    """
    ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å‡∏î‡πâ‡∏ß‡∏¢ keyword ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LLM
    """
    text = (news.get("title", "") + " " + news.get("summary", "")).lower()
    return any(k in text for k in KEYWORD_SUBSTRINGS)


# ============================================================================================================
# ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Ç‡πà‡∏≤‡∏ß (og:image / twitter:image / <img> ‡πÅ‡∏£‡∏Å)
# ============================================================================================================
def fetch_article_image(url: str) -> str:
    """
    ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á URL ‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á
    """
    if not url:
        return ""

    try:
        r = S.get(url, timeout=TIMEOUT)
        if r.status_code >= 400:
            return ""

        html = r.text

        # og:image
        m = re.search(
            r'<meta[^>]+property=[\'"]og:image[\'"][^>]+content=[\'"]([^\'"]+)[\'"]',
            html,
            re.I,
        )
        if m:
            return m.group(1)

        # twitter:image
        m = re.search(
            r'<meta[^>]+name=[\'"]twitter:image[\'"][^>]+content=[\'"]([^\'"]+)[\'"]',
            html,
            re.I,
        )
        if m:
            return m.group(1)

        # <img> ‡πÅ‡∏£‡∏Å
        m = re.search(r'<img[^>]+src=[\'"]([^\'"]+)[\'"]', html, re.I)
        if m:
            src = m.group(1)
            if src.startswith("//"):
                parsed = urlparse(url)
                return f"{parsed.scheme}:{src}"
            if src.startswith("/"):
                parsed = urlparse(url)
                return f"{parsed.scheme}://{parsed.netloc}{src}"
            return src

        return ""
    except Exception:
        return ""


# ============================================================================================================
# CONTEXT: ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡πä‡∏≤‡∏ã + ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ PTTEP ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
# ============================================================================================================
PTT_CONTEXT = r"""
[‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ‡∏õ‡∏ï‡∏ó.]

‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- ‡∏î‡∏π‡πÅ‡∏•‡∏´‡πà‡∏ß‡∏á‡πÇ‡∏ã‡πà‡∏≠‡∏∏‡∏õ‡∏ó‡∏≤‡∏ô‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à ‡∏ú‡∏•‡∏¥‡∏ï ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ ‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢
- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å: ‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (NG), ‡∏Å‡πä‡∏≤‡∏ã‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡πÄ‡∏´‡∏•‡∏ß (LPG), ‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå (NGV)
- ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÄ‡∏´‡∏•‡∏ß (LNG) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®

‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å
1) ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
- ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÄ‡∏´‡∏•‡∏ß (LNG) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®

2) ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ
- ‡∏ô‡∏≥‡∏Å‡πä‡∏≤‡∏ã‡∏î‡∏¥‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏™‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã
- ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÇ‡∏£‡∏á‡πÅ‡∏¢‡∏Å‡∏Å‡πä‡∏≤‡∏ã‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡πä‡∏≤‡∏ã‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° ‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ LPG ‡πÅ‡∏•‡∏∞ NGV
- ‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏ô‡∏†‡∏≤‡∏Ñ‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° ‡∏†‡∏≤‡∏Ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ‡∏Ç‡∏ô‡∏™‡πà‡∏á

3) ‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏™‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- ‡∏£‡πâ‡∏≤‡∏ô / ‡∏Ñ‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏Å‡πä‡∏≤‡∏ã‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡πÄ‡∏´‡∏•‡∏ß (LPG)
- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ NGV
- ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏Å‡πä‡∏≤‡∏ã‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏´‡πà‡∏ß‡∏á‡πÇ‡∏ã‡πà‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
- ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á: ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (‡πÉ‡∏ô‚Äì‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®), ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ê‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏±‡∏°‡∏õ‡∏ó‡∏≤‡∏ô
- ‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏≤‡∏á: ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡∏Ç‡∏≠‡∏á‡∏Å‡πä‡∏≤‡∏ã, ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏™‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã, ‡πÇ‡∏£‡∏á‡πÅ‡∏¢‡∏Å‡∏Å‡πä‡∏≤‡∏ã
- ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°, ‡πÇ‡∏£‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤, ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á (NGV), ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö LPG

‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
- ‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÑ‡∏î‡πâ
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏†‡∏≤‡∏Ñ‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° ‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ ‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏ü‡∏ü‡πâ‡∏≤
- ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î

‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ç‡πà‡∏≤‡∏ß
- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ‡∏õ‡∏ï‡∏ó. ‡∏î‡∏π‡πÅ‡∏•‡∏´‡πà‡∏ß‡∏á‡πÇ‡∏ã‡πà‡∏≠‡∏∏‡∏õ‡∏ó‡∏≤‡∏ô‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
  ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏≤ ‡∏ú‡∏•‡∏¥‡∏ï ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏™‡πà‡∏á‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÇ‡∏£‡∏á‡πÅ‡∏¢‡∏Å‡∏Å‡πä‡∏≤‡∏ã
  ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ LNG ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
"""

PTTEP_PROJECTS_CONTEXT = r"""
[PTTEP_PROJECTS_CONTEXT]

‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (Thailand)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ G1/61 (Erawan, Platong, Satun, Funan) ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ G2/61 (Bongkot ‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á) ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Arthit ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢ (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏±‡∏Å‡∏î‡∏±‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ CCS ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ S1 ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏ö‡∏ô‡∏ö‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Contract 4 ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ B8/32 ‡πÅ‡∏•‡∏∞ 9A ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Sinphuhorm ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ MTJDA Block A-18 ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‚Äì‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢ (Malaysia‚ÄìThailand Joint Development Area)

‡πÄ‡∏°‡∏µ‡∏¢‡∏ô‡∏°‡∏≤ (Myanmar)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Zawtika ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡∏°‡∏≠‡∏î‡∏ï‡∏∞‡∏°‡∏∞ ‡∏™‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ó‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡πà‡∏≠‡∏™‡πà‡∏á
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Yadana ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏•‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô‡∏ó‡∏µ‡πà PTTEP ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Yetagun ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏•‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô‡∏ó‡∏µ‡πà PTTEP ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô

‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏° (Vietnam)
- Block B & 48/95 ‡πÅ‡∏•‡∏∞ Block 52/97 ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πä‡∏≤‡∏ã‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ 16-1 (Te Giac Trang) ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏•‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°‡∏ï‡∏≠‡∏ô‡πÉ‡∏ï‡πâ‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô

‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢ (Malaysia)
- MTJDA Block A-18 ‚Äì ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‚Äì‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô SK309, SK311, SK410B ‡∏Ø‡∏•‡∏Ø ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà PTTEP ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£

‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢ (Indonesia)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ South Sageri, South Mandar, Malunda ‡πÅ‡∏•‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à/‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á

‡∏™‡∏´‡∏£‡∏±‡∏ê‡∏≠‡∏≤‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏°‡∏¥‡πÄ‡∏£‡∏ï‡∏™‡πå (United Arab Emirates ‚Äì UAE)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Ghasha Concession ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ sour gas ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏≠‡∏á UAE ‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Abu Dhabi Offshore ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡πä‡∏≤‡∏ã/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡πÉ‡∏ô‡∏≠‡∏≤‡∏ö‡∏π‡∏î‡∏≤‡∏ö‡∏µ

‡πÇ‡∏≠‡∏°‡∏≤‡∏ô (Oman)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Oman Block 12 ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏ö‡∏ô‡∏ö‡∏Å‡πÉ‡∏ô‡πÇ‡∏≠‡∏°‡∏≤‡∏ô

‡πÅ‡∏≠‡∏•‡∏à‡∏µ‡πÄ‡∏£‡∏µ‡∏¢ (Algeria)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Bir Seba, Hirad, Touat ‡∏Ø‡∏•‡∏Ø ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏Å‡πä‡∏≤‡∏ã‡∏ö‡∏ô‡∏ö‡∏Å‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö SONATRACH ‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£

‡πÇ‡∏°‡∏ã‡∏±‡∏°‡∏ö‡∏¥‡∏Å (Mozambique)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Mozambique Area 1 (Rovuma LNG) ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πä‡∏≤‡∏ã‡πÅ‡∏•‡∏∞ LNG ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô‡πÅ‡∏≠‡∏ü‡∏£‡∏¥‡∏Å‡∏≤‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô

‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢ (Australia)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Montara ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÉ‡∏ô Timor Sea / Browse Basin ‡∏ú‡πà‡∏≤‡∏ô PTTEP Australasia

‡∏ö‡∏£‡∏≤‡∏ã‡∏¥‡∏• (Brazil)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ BM-ES-23, BM-ES-24 ‡πÅ‡∏•‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô

‡πÄ‡∏°‡πá‡∏Å‡∏ã‡∏¥‡πÇ‡∏Å (Mexico)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Mexico Block 12 (2.4) ‡πÅ‡∏•‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ö‡πà‡∏≠‡∏ó‡∏∞‡πÄ‡∏•‡∏•‡∏∂‡∏Å‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÄ‡∏°‡πá‡∏Å‡∏ã‡∏¥‡πÇ‡∏Å

‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
- PTTEP ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≤‡∏ã‡∏±‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô ‡πÅ‡∏≠‡∏á‡πÇ‡∏Å‡∏•‡∏≤ ‡πÅ‡∏Ñ‡∏ô‡∏≤‡∏î‡∏≤ ‡∏Ø‡∏•‡∏Ø ‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏¢‡πà‡∏≠‡∏¢

‡∏™‡∏£‡∏∏‡∏õ:
- ‡∏ñ‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP
- ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÅ‡∏°‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
[/PTTEP_PROJECTS_CONTEXT]
"""


# ============================================================================================================
# GEMINI CALL WRAPPER
# ============================================================================================================
GEMINI_CALLS = 0


def call_gemini(prompt):
    global GEMINI_CALLS

    if GEMINI_CALLS >= GEMINI_DAILY_BUDGET:
        raise RuntimeError("‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ Gemini ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô")

    last_error = None
    for i in range(1, MAX_RETRIES + 1):
        try:
            r = model.generate_content(prompt)
            GEMINI_CALLS += 1
            return r
        except Exception as e:
            last_error = e
            if (
                any(x in str(e) for x in ["429", "unavailable", "deadline", "503", "500"])
                and i < MAX_RETRIES
            ):
                time.sleep(5 * i)
                continue
            raise e

    raise last_error


# ============================================================================================================
# FILTER ‚Üí ‡∏Ç‡πà‡∏≤‡∏ß‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠ "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ PTTEP ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
# ============================================================================================================
def llm_filter(news):
    """
    ‡πÉ‡∏ä‡πâ LLM ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤
    ‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ï‡πà‡∏≠ "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï/‡∏Å‡πä‡∏≤‡∏ã" ‡∏Ç‡∏≠‡∏á PTTEP
    ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (‡∏ï‡∏≤‡∏° PTTEP_PROJECTS_CONTEXT) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    """
    prompt = f"""
{PTT_CONTEXT}
{PTTEP_PROJECTS_CONTEXT}

‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: News Screener ‡∏Ç‡∏≠‡∏á ‡∏õ‡∏ï‡∏ó.‡∏™‡∏ú. (PTTEP)
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ß‡πà‡∏≤
‚Äú‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï/‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡∏≠‡∏á PTTEP
‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÉ‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô [PTTEP_PROJECTS_CONTEXT] ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‚Äù

‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô [PTTEP_PROJECTS_CONTEXT] ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Å‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "‡πÉ‡∏ä‡πà" ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏Ç‡πâ‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á:
- ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏±‡πâ‡∏ô
  ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à/‡∏û‡∏±‡∏í‡∏ô‡∏≤/‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô ‡πÜ
- ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
  ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã, ‡∏ó‡πà‡∏≠‡∏™‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã, LNG, ‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠, FPSO, ‡πÅ‡∏ó‡πà‡∏ô‡∏ú‡∏•‡∏¥‡∏ï ‡∏Ø‡∏•‡∏Ø
- ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏£‡∏±‡∏ê ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏†‡∏≤‡∏©‡∏µ ‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏Ñ‡∏´‡∏•‡∏ß‡∏á ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏™‡∏±‡∏°‡∏õ‡∏ó‡∏≤‡∏ô/PSC
  ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á/‡∏†‡∏π‡∏°‡∏¥‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏µ‡πà PTTEP ‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
  ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
- ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡πÄ‡∏ã‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
  ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï ‡∏Å‡πä‡∏≤‡∏ã ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏µ‡πà PTTEP ‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
- ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏á‡∏ö ‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏° ‡∏Ñ‡∏ß‡πà‡∏≥‡∏ö‡∏≤‡∏ï‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
  ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP (‡πÄ‡∏ä‡πà‡∏ô Myanmar, Mozambique, Algeria, UAE ‡∏Ø‡∏•‡∏Ø)

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà" ‡∏ñ‡πâ‡∏≤:
- ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô/‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞
  ‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô context
- ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πà‡∏≤‡∏ß downstream, ‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î, retail, EV, ‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥,
  ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏ß PR/CSR ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï/‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡∏≠‡∏á PTTEP
- ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•‡∏ß‡πà‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP
  ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÉ‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏à‡∏≤‡∏Å [PTTEP_PROJECTS_CONTEXT]

‡∏Ç‡πà‡∏≤‡∏ß:
‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: {news['title']}
‡∏™‡∏£‡∏∏‡∏õ: {news['summary']}
‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {news.get('detail','')}

‡∏ï‡∏≠‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°):
- ‡πÉ‡∏ä‡πà
- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà
"""

    try:
        r = call_gemini(prompt)
        ans = (r.text or "").strip().replace("\n", "")
        return ans.startswith("‡πÉ‡∏ä‡πà")
    except Exception:
        return False


# ============================================================================================================
# TAG ‡∏Ç‡πà‡∏≤‡∏ß (‡∏™‡∏£‡∏∏‡∏õ + ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó + ‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ + ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö + ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á)
# ============================================================================================================
def gemini_tag(news):
    """
    ‡πÉ‡∏´‡πâ LLM ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß + ‡∏ï‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πà‡∏≤‡∏ß + ‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ + ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡∏≠‡∏á ‡∏õ‡∏ï‡∏ó.
    ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® / ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ PTTEP ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏≤‡πÑ‡∏î‡πâ)
    """
    schema = {
        "type": "object",
        "properties": {
            "summary": {"type": "string"},
            "topic_type": {
                "type": "string",
                "enum": [
                    "supply_disruption",
                    "price_move",
                    "policy",
                    "investment",
                    "geopolitics",
                    "other",
                ],
            },
            "region": {
                "type": "string",
                "enum": ["global", "asia", "europe", "middle_east", "us", "other"],
            },
            "impact_reason": {"type": "string"},
            "country": {"type": "string"},
            "projects": {
                "type": "array",
                "items": {"type": "string"},
            },
        },
        "required": ["summary", "topic_type", "region", "impact_reason"],
    }

    prompt = f"""
{PTT_CONTEXT}
{PTTEP_PROJECTS_CONTEXT}

‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: Analyst ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ‡∏õ‡∏ï‡∏ó.
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏´‡πà‡∏ß‡∏á‡πÇ‡∏ã‡πà‡∏Å‡πä‡∏≤‡∏ã‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£

‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡∏Ç‡πà‡∏≤‡∏ß:
‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: {news['title']}
‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å RSS: {news['summary']}
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {news.get('detail','')}

‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤:
- summary: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 2‚Äì4 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
- impact_reason: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö bullet ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö)
- country: ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô Thailand, Myanmar, Vietnam, Mozambique, UAE ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
- projects: ‡∏ñ‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô list
  ‡πÄ‡∏ä‡πà‡∏ô ["G1/61", "Arthit"], ["Zawtika"], ["Mozambique Area 1"], ["Ghasha"], ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
  ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ [] ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ï‡∏≤‡∏° schema ‡∏ô‡∏µ‡πâ:
{json.dumps(schema, ensure_ascii=False)}
"""

    try:
        r = call_gemini(prompt)
        raw = (r.text or "").strip()

        # ‡∏ï‡∏±‡∏î ``` ‡∏´‡∏£‡∏∑‡∏≠ ```json ‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if raw.startswith("```"):
            raw = re.sub(r"^```(json)?", "", raw).strip()
            raw = re.sub(r"```$", "", raw).strip()

        return json.loads(raw)
    except Exception:
        return {
            "summary": news["summary"],
            "topic_type": "other",
            "region": "other",
            "impact_reason": "-",
        }


# ============================================================================================================
# FETCH NEWS
# ============================================================================================================
NEWS_FEEDS = [
    ("Oilprice", "Energy", "https://oilprice.com/rss/main"),
    ("CleanTechnica", "Energy", "https://cleantechnica.com/feed/"),
    ("HydrogenFuelNews", "Energy", "https://www.hydrogenfuelnews.com/feed/"),
    ("Economist", "Economy", "https://www.economist.com/latest/rss.xml"),
    ("YahooFinance", "Economy", "https://finance.yahoo.com/news/rssindex"),
]


def fetch_news_window():
    now_local = datetime.now(bangkok_tz)

    # ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 21:00 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ‡∏ñ‡∏∂‡∏á 06:00 ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    start = (now_local - timedelta(days=1)).replace(
        hour=21, minute=0, second=0, microsecond=0
    )
    end = now_local.replace(hour=6, minute=0, second=0, microsecond=0)

    out = []

    for site, cat, url in NEWS_FEEDS:
        try:
            feed = feedparser.parse(url)
            for e in feed.entries:
                pub = getattr(e, "published", None) or getattr(e, "updated", None)
                if not pub:
                    continue

                dt = dateutil_parser.parse(pub)
                if dt.tzinfo is None:
                    dt = pytz.UTC.localize(dt)
                dt = dt.astimezone(bangkok_tz)

                if start <= dt <= end:
                    out.append(
                        {
                            "site": site,
                            "category": cat,
                            "title": e.title,
                            "summary": getattr(e, "summary", ""),
                            "link": e.link,
                            "published": dt,
                            "date": dt.strftime("%d/%m/%Y %H:%M"),
                        }
                    )
        except Exception:
            pass

    # dedupe ‡∏ï‡∏≤‡∏° link
    uniq = []
    seen = set()
    for n in out:
        k = _normalize_link(n["link"])
        if k not in seen:
            seen.add(k)
            uniq.append(n)

    return uniq


# ============================================================================================================
# GROUP NEWS
# ============================================================================================================
def group_news(news_list, min_size=3):
    buckets = {}
    for n in news_list:
        key = (n.get("topic_type"), n.get("region"))
        buckets.setdefault(key, []).append(n)

    out = []
    for (topic, region), items in buckets.items():
        if len(items) >= min_size:
            items_sorted = sorted(items, key=lambda x: x["published"], reverse=True)
            anchor = items_sorted[0]
            out.append(
                {
                    "is_group": True,
                    "topic_type": topic,
                    "region": region,
                    "news_items": items_sorted,
                    "title": anchor["title"],
                    "site": "‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß",
                    "category": anchor["category"],
                    "date": anchor["date"],
                    "published": anchor["published"],
                    "link": anchor["link"],
                }
            )
        else:
            out.extend(items)

    return out


# ============================================================================================================
# SUMMARIZE GROUP
# ============================================================================================================
def gemini_group_summary(group):
    block = "\n".join(
        [f"- {n['title']}: {n['summary']}" for n in group["news_items"]]
    )

    prompt = f"""
{PTT_CONTEXT}
{PTTEP_PROJECTS_CONTEXT}

‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: Analyst ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß" ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡∏≠‡∏á ‡∏õ‡∏ï‡∏ó.
‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ô‡∏µ‡πâ (topic + region)
‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏´‡πà‡∏ß‡∏á‡πÇ‡∏ã‡πà‡∏Å‡πä‡∏≤‡∏ã ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á

‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß (‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡πà‡∏≠‡∏¢):
{block}

‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤:
- summary: ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß 3‚Äì5 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
- impact_reason: ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô bullet ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏´‡πà‡∏ß‡∏á‡πÇ‡∏ã‡πà‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡∏≠‡∏á ‡∏õ‡∏ï‡∏ó. ‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£
  (‡πÄ‡∏ä‡πà‡∏ô supply risk, LNG infrastructure, gas pipeline, ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏£‡∏±‡∏ê, ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πä‡∏≤‡∏ã, ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏Ø‡∏•‡∏Ø)

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
{{
  "summary": "<‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢>",
  "impact_reason": "<‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡∏≠‡∏á ‡∏õ‡∏ï‡∏ó. ‡πÄ‡∏õ‡πá‡∏ô bullet/‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î>"
}}
"""

    try:
        r = call_gemini(prompt)
        raw = (r.text or "").strip()

        if raw.startswith("```"):
            raw = re.sub(r"^```(json)?", "", raw).strip()
            raw = re.sub(r"```$", "", raw).strip()

        return json.loads(raw)
    except Exception:
        return {"summary": "‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "impact_reason": "-"}


# ============================================================================================================
# FLEX MESSAGE
# ============================================================================================================
def create_flex(news_items):
    now_txt = datetime.now(bangkok_tz).strftime("%d/%m/%Y")
    bubbles = []

    for n in news_items:
        bullets = _impact_to_bullets(n.get("impact_reason", "-"))

        link = n.get("link") or ""
        if not (isinstance(link, str) and link.startswith(("http://", "https://"))):
            link = "https://www.google.com/search?q=energy+gas+news"

        img = n.get("image") or DEFAULT_ICON_URL
        if not (isinstance(img, str) and img.startswith(("http://", "https://"))):
            img = DEFAULT_ICON_URL

        body_contents = [
            {
                "type": "text",
                "text": n["title"],
                "weight": "bold",
                "size": "lg",
                "wrap": True,
            },
            {
                "type": "text",
                "text": f"üóì {n['date']}",
                "size": "xs",
                "color": "#888888",
                "margin": "sm",
            },
            {
                "type": "text",
                "text": f"üåç {n['site']}",
                "size": "xs",
                "color": "#448AFF",
                "margin": "xs",
            },
            {
                "type": "text",
                "text": f"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: {n['topic_type']} | ‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ: {n['region']}",
                "size": "xs",
                "color": "#555555",
                "margin": "sm",
            },
        ]

        # ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏à‡∏≤‡∏Å LLM (‡∏´‡∏£‡∏∑‡∏≠ summary ‡πÄ‡∏î‡∏¥‡∏°)
        summary_txt = (
            n.get("summary_llm")
            or n.get("summary")
            or ""
        ).strip()

        if summary_txt:
            if len(summary_txt) > 260:
                summary_txt = summary_txt[:257] + "..."

            body_contents.append(
                {
                    "type": "text",
                    "text": summary_txt,
                    "wrap": True,
                    "size": "sm",
                    "margin": "md",
                }
            )

        impact_box = {
            "type": "box",
            "layout": "vertical",
            "margin": "lg",
            "contents": [
                {
                    "type": "text",
                    "text": "‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó.",
                    "size": "lg",
                    "weight": "bold",
                    "color": "#000000",
                }
            ]
            + [
                {
                    "type": "text",
                    "text": f"‚Ä¢ {b}",
                    "wrap": True,
                    "size": "md",
                    "color": "#000000",
                    "weight": "bold",
                    "margin": "xs",
                }
                for b in bullets
            ],
        }

        body_contents.append(impact_box)

        bubble = {
            "type": "bubble",
            "size": "mega",
            "hero": {
                "type": "image",
                "url": img,
                "size": "full",
                "aspectRatio": "16:9",
                "aspectMode": "cover",
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": body_contents,
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "style": "primary",
                        "color": "#1DB446",
                        "action": {
                            "type": "uri",
                            "label": "‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠",
                            "uri": link,
                        },
                    }
                ],
            },
        }

        bubbles.append(bubble)

    return [
        {
            "type": "flex",
            "altText": f"‡∏Ç‡πà‡∏≤‡∏ß ‡∏õ‡∏ï‡∏ó. {now_txt}",
            "contents": {"type": "carousel", "contents": bubbles},
        }
    ]


# ============================================================================================================
# BROADCAST LINE
# ============================================================================================================
def send_to_line(messages):
    url = "https://api.line.me/v2/bot/message/broadcast"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {LINE_CHANNEL_ACCESS_TOKEN}",
    }

    for i, msg in enumerate(messages, 1):
        payload = {"messages": [msg]}

        print("=== LINE PAYLOAD ===")
        print(json.dumps(payload, ensure_ascii=False, indent=2))

        if DRY_RUN:
            print("[DRY_RUN] ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ DRY_RUN = true")
            continue

        r = S.post(url, headers=headers, json=payload, timeout=15)
        print(f"Send {i}: {r.status_code}")
        print("Response body:", r.text)

        if r.status_code >= 300:
            break


# ============================================================================================================
# MAIN WORKFLOW
# ============================================================================================================
def main():
    print("‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß...")
    all_news_raw = fetch_news_window()
    print("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:", len(all_news_raw))

    # keyword pre-filter
    candidates = [n for n in all_news_raw if keyword_pre_filter(n)]
    print("‡∏´‡∏•‡∏±‡∏á keyword pre-filter:", len(candidates))

    # ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô MAX_NEWS_PER_RUN
    if len(candidates) > MAX_NEWS_PER_RUN:
        candidates = candidates[:MAX_NEWS_PER_RUN]
        print(f"‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {len(candidates)} ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LLM (MAX_NEWS_PER_RUN)")

    all_news = candidates

    filtered = []
    for n in all_news:
        n["detail"] = n["title"] if len(n["summary"]) < 50 else ""
        if llm_filter(n):
            filtered.append(n)
        time.sleep(random.uniform(*SLEEP_BETWEEN_CALLS))

    print("‡∏ú‡πà‡∏≤‡∏ô llm_filter:", len(filtered))

    if not filtered:
        print("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á")
        return

    print("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢ LLM (tag + summary)...")
    tagged = []
    for n in filtered:
        tag = gemini_tag(n)

        n["topic_type"] = tag.get("topic_type", "other")
        n["region"] = tag.get("region", "other")
        n["impact_reason"] = tag.get("impact_reason", "-")
        n["summary_llm"] = (
            tag.get("summary")
            or n.get("summary")
            or n["title"]
        )

        tagged.append(n)
        time.sleep(random.uniform(*SLEEP_BETWEEN_CALLS))

    grouped = group_news(tagged)
    print("‡∏´‡∏•‡∏±‡∏á group:", len(grouped))

    for g in grouped:
        if g.get("is_group"):
            meta = gemini_group_summary(g)
            g["summary_llm"] = meta.get("summary", "")
            g["impact_reason"] = meta.get("impact_reason", "-")

    selected = grouped[:10]

    sent = load_sent_links()
    final = [n for n in selected if _normalize_link(n["link"]) not in sent]
    print("‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤:", len(final))

    if not final:
        print("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà")
        return

    for n in final:
        img = fetch_article_image(n.get("link", ""))
        if not (isinstance(img, str) and img.startswith(("http://", "https://"))):
            img = DEFAULT_ICON_URL
        n["image"] = img
        time.sleep(0.5)

    msgs = create_flex(final)
    send_to_line(msgs)
    save_sent_links([n["link"] for n in final])

    print("‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô")


# ============================================================================================================
if __name__ == "__main__":
    main()
