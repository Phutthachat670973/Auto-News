# ============================================================================================================
# IMPORT & ENV
# ============================================================================================================
import os
import re
import json
import time
import random
from datetime import datetime, timedelta
from urllib.parse import urlparse, urlunparse, parse_qsl, urlencode

import feedparser
from dateutil import parser as dateutil_parser
import pytz
import requests
import google.generativeai as genai

try:
    from dotenv import load_dotenv
    load_dotenv()
except Exception:
    pass

GEMINI_API_KEY = os.getenv("GEMINI_API_KEY", "").strip()
LINE_CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN", "").strip()

if not GEMINI_API_KEY:
    raise RuntimeError("‡πÑ‡∏°‡πà‡∏û‡∏ö GEMINI_API_KEY")

if not LINE_CHANNEL_ACCESS_TOKEN:
    raise RuntimeError("‡πÑ‡∏°‡πà‡∏û‡∏ö LINE_CHANNEL_ACCESS_TOKEN")

genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel(os.getenv("GEMINI_MODEL_NAME", "gemini-2.5-flash"))

GEMINI_DAILY_BUDGET = int(os.getenv("GEMINI_DAILY_BUDGET", "250"))
MAX_RETRIES = 6

# ‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤ sleep ‡∏•‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
SLEEP_BETWEEN_CALLS = (2.0, 3.0)

DRY_RUN = os.getenv("DRY_RUN", "false").lower() == "true"

bangkok_tz = pytz.timezone("Asia/Bangkok")
now = datetime.now(bangkok_tz)

S = requests.Session()
S.headers.update({"User-Agent": "Mozilla/5.0"})
TIMEOUT = 15

SENT_LINKS_DIR = "sent_links"
os.makedirs(SENT_LINKS_DIR, exist_ok=True)

# ‡∏£‡∏π‡∏õ default ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö hero ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á ‡πÜ
DEFAULT_ICON_URL = "https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png"


# ============================================================================================================
# HELPERS
# ============================================================================================================
def _normalize_link(url: str) -> str:
    try:
        p = urlparse(url)
        netloc = p.netloc.lower()
        scheme = (p.scheme or "https").lower()

        drop = {"fbclid", "gclid", "ref", "mc_cid", "mc_eid"}
        new_q = [
            (k, v)
            for k, v in parse_qsl(p.query, keep_blank_values=True)
            if not (k.startswith("utm_") or k in drop)
        ]

        return urlunparse(
            p._replace(
                scheme=scheme,
                netloc=netloc,
                query=urlencode(new_q),
            )
        )
    except Exception:
        return (url or "").strip()


def get_sent_links_file(date=None):
    if date is None:
        date = datetime.now(bangkok_tz).strftime("%Y-%m-%d")
    return os.path.join(SENT_LINKS_DIR, f"{date}.txt")


def load_sent_links():
    """
    ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á '‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    """
    sent = set()
    today_str = datetime.now(bangkok_tz).strftime("%Y-%m-%d")
    p = get_sent_links_file(today_str)

    if os.path.exists(p):
        with open(p, "r", encoding="utf-8") as f:
            for line in f:
                u = _normalize_link(line.strip())
                if u:
                    sent.add(u)

    return sent


def save_sent_links(links):
    p = get_sent_links_file()
    with open(p, "a", encoding="utf-8") as f:
        for l in links:
            f.write(_normalize_link(l) + "\n")


def _impact_to_bullets(text: str):
    """
    ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° impact_reason ‡πÄ‡∏õ‡πá‡∏ô list bullet ‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡πÜ:
    - ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å
    - ‡∏•‡∏ö‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‚Ä¢ * - ¬∑ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö 1. 2) ‡∏≠‡∏≠‡∏Å
    - ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏î‡∏≠‡∏Å‡∏à‡∏±‡∏ô‡∏´‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
    """
    if not text:
        return ["‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"]

    lines = [l.strip() for l in text.splitlines() if l.strip()]
    if not lines:
        lines = [text.strip()]

    bullets = []
    for line in lines:
        s = line.strip()
        # ‡∏•‡∏ö bullet symbols ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤: ‚Ä¢ * - ¬∑ ‡∏Ø‡∏•‡∏Ø
        s = re.sub(r"^[\u2022\*\-\u00b7¬∑‚Ä¢\s]+", "", s)
        # ‡∏•‡∏ö‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô "1." "2)" "3 ." ‡∏≠‡∏≠‡∏Å
        s = re.sub(r"^\d+[\.\)]\s*", "", s)
        # ‡∏•‡∏ö‡∏î‡∏≠‡∏Å‡∏à‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏´‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ö‡∏ö ".* ..." ‡∏´‡∏£‡∏∑‡∏≠ "* ..."
        if s.startswith(".*"):
            s = s[2:].lstrip()
        if s.startswith("*"):
            s = s[1:].lstrip()
        if s:
            bullets.append(s)

    return bullets or ["‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"]


def has_meaningful_impact(impact_text: str) -> bool:
    """
    ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ False ‡∏ñ‡πâ‡∏≤ impact_text ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏ß
    '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP' (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á)
    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ insight ‡∏à‡∏£‡∏¥‡∏á
    """
    if not impact_text:
        return False

    t = impact_text.lower().replace(" ", "")
    patterns = [
        "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏ápttep",
        "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏ápttep",
        "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏ápttep",
    ]
    for p in patterns:
        if p in t:
            return False

    return True


# ============================================================================================================
# ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Ç‡πà‡∏≤‡∏ß (og:image / twitter:image / <img> ‡πÅ‡∏£‡∏Å)
# ============================================================================================================
def fetch_article_image(url: str) -> str:
    """
    ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á URL ‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á
    """
    if not url:
        return ""

    try:
        r = S.get(url, timeout=TIMEOUT)
        if r.status_code >= 400:
            return ""

        html = r.text

        # og:image
        m = re.search(
            r'<meta[^>]+property=[\'"]og:image[\'"][^>]+content=[\'"]([^\'"]+)[\'"]',
            html,
            re.I,
        )
        if m:
            return m.group(1)

        # twitter:image
        m = re.search(
            r'<meta[^>]+name=[\'"]twitter:image[\'"][^>]+content=[\'"]([^\'"]+)[\'"]',
            html,
            re.I,
        )
        if m:
            return m.group(1)

        # <img> ‡πÅ‡∏£‡∏Å
        m = re.search(r'<img[^>]+src=[\'"]([^\'"]+)[\'"]', html, re.I)
        if m:
            src = m.group(1)
            if src.startswith("//"):
                parsed = urlparse(url)
                return f"{parsed.scheme}:{src}"
            if src.startswith("/"):
                parsed = urlparse(url)
                return f"{parsed.scheme}://{parsed.netloc}{src}"
            return src

        return ""
    except Exception:
        return ""


# ============================================================================================================
# CONTEXT
# ============================================================================================================
PTT_CONTEXT = r"""
[‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ‡∏õ‡∏ï‡∏ó.]

‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- ‡∏î‡∏π‡πÅ‡∏•‡∏´‡πà‡∏ß‡∏á‡πÇ‡∏ã‡πà‡∏≠‡∏∏‡∏õ‡∏ó‡∏≤‡∏ô‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à ‡∏ú‡∏•‡∏¥‡∏ï ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ ‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢
- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å: ‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (NG), ‡∏Å‡πä‡∏≤‡∏ã‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡πÄ‡∏´‡∏•‡∏ß (LPG), ‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå (NGV)
- ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÄ‡∏´‡∏•‡∏ß (LNG) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
"""

PTTEP_PROJECTS_CONTEXT = r"""
[PTTEP_PROJECTS_CONTEXT]

‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (Thailand)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ G1/61 (Erawan, Platong, Satun, Funan) ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ G2/61 (Bongkot ‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏•‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á) ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Arthit ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢ (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏±‡∏Å‡∏î‡∏±‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ CCS ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ S1 ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏ö‡∏ô‡∏ö‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Contract 4 ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ B8/32 ‡πÅ‡∏•‡∏∞ 9A ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Sinphuhorm ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ MTJDA Block A-18 ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‚Äì‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢

‡πÄ‡∏°‡∏µ‡∏¢‡∏ô‡∏°‡∏≤ (Myanmar)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Zawtika ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡∏°‡∏≠‡∏î‡∏ï‡∏∞‡∏°‡∏∞ ‡∏™‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ó‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡πà‡∏≠‡∏™‡πà‡∏á
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Yadana ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏•‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô‡∏ó‡∏µ‡πà PTTEP ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Yetagun ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏•‡∏≠‡∏±‡∏ô‡∏î‡∏≤‡∏°‡∏±‡∏ô‡∏ó‡∏µ‡πà PTTEP ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô

‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏° (Vietnam)
- Block B & 48/95 ‡πÅ‡∏•‡∏∞ Block 52/97 ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πä‡∏≤‡∏ã‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ 16-1 (Te Giac Trang) ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏Å‡πä‡∏≤‡∏ã‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏•‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°‡∏ï‡∏≠‡∏ô‡πÉ‡∏ï‡πâ‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô

‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢ (Malaysia)
- MTJDA Block A-18 ‚Äì ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‚Äì‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô SK309, SK311, SK410B ‡∏Ø‡∏•‡∏Ø ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà PTTEP ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£

‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢ (Indonesia)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ South Sageri, South Mandar, Malunda ‡πÅ‡∏•‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à/‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡πä‡∏≤‡∏ã‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á

‡∏™‡∏´‡∏£‡∏±‡∏ê‡∏≠‡∏≤‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏°‡∏¥‡πÄ‡∏£‡∏ï‡∏™‡πå (United Arab Emirates ‚Äì UAE)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Ghasha Concession ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ sour gas ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏≠‡∏á UAE ‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Abu Dhabi Offshore ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡πä‡∏≤‡∏ã/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡πÉ‡∏ô‡∏≠‡∏≤‡∏ö‡∏π‡∏î‡∏≤‡∏ö‡∏µ

‡πÇ‡∏≠‡∏°‡∏≤‡∏ô (Oman)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Oman Block 12 ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏ö‡∏ô‡∏ö‡∏Å‡πÉ‡∏ô‡πÇ‡∏≠‡∏°‡∏≤‡∏ô

‡πÅ‡∏≠‡∏•‡∏à‡∏µ‡πÄ‡∏£‡∏µ‡∏¢ (Algeria)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Bir Seba, Hirad, Touat ‡∏Ø‡∏•‡∏Ø ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏Å‡πä‡∏≤‡∏ã‡∏ö‡∏ô‡∏ö‡∏Å‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö SONATRACH ‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£

‡πÇ‡∏°‡∏ã‡∏±‡∏°‡∏ö‡∏¥‡∏Å (Mozambique)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Mozambique Area 1 (Rovuma LNG) ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πä‡∏≤‡∏ã‡πÅ‡∏•‡∏∞ LNG ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô‡πÅ‡∏≠‡∏ü‡∏£‡∏¥‡∏Å‡∏≤‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô

‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢ (Australia)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Montara ‚Äì ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÉ‡∏ô Timor Sea / Browse Basin ‡∏ú‡πà‡∏≤‡∏ô PTTEP Australasia

‡∏ö‡∏£‡∏≤‡∏ã‡∏¥‡∏• (Brazil)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ BM-ES-23, BM-ES-24 ‡πÅ‡∏•‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ô‡∏≠‡∏Å‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà PTTEP ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô

‡πÄ‡∏°‡πá‡∏Å‡∏ã‡∏¥‡πÇ‡∏Å (Mexico)
- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Mexico Block 12 (2.4) ‡πÅ‡∏•‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Äì ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ö‡πà‡∏≠‡∏ó‡∏∞‡πÄ‡∏•‡∏•‡∏∂‡∏Å‡πÉ‡∏ô‡∏≠‡πà‡∏≤‡∏ß‡πÄ‡∏°‡πá‡∏Å‡∏ã‡∏¥‡πÇ‡∏Å

‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
- PTTEP ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≤‡∏ã‡∏±‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô ‡πÅ‡∏≠‡∏á‡πÇ‡∏Å‡∏•‡∏≤ ‡πÅ‡∏Ñ‡∏ô‡∏≤‡∏î‡∏≤ ‡∏Ø‡∏•‡∏Ø ‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏¢‡πà‡∏≠‡∏¢
"""


# ============================================================================================================
# GEMINI CALL WRAPPER
# ============================================================================================================
GEMINI_CALLS = 0


def call_gemini(prompt):
    global GEMINI_CALLS

    if GEMINI_CALLS >= GEMINI_DAILY_BUDGET:
        raise RuntimeError("‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ Gemini ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô")

    last_error = None
    for i in range(1, MAX_RETRIES + 1):
        try:
            r = model.generate_content(prompt)
            GEMINI_CALLS += 1
            return r
        except Exception as e:
            last_error = e
            if (
                any(x in str(e) for x in ["429", "unavailable", "deadline", "503", "500"])
                and i < MAX_RETRIES
            ):
                time.sleep(5 * i)
                continue
            raise e

    raise last_error


# ============================================================================================================
# FILTER ‚Üí ‡∏Ç‡πà‡∏≤‡∏ß‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠ "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ PTTEP / ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
# ============================================================================================================
def llm_filter(news):
    """
    ‡πÉ‡∏ä‡πâ LLM ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤
    ‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ï‡πà‡∏≠ "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏¥‡∏ï/‡∏Å‡πä‡∏≤‡∏ã" ‡∏Ç‡∏≠‡∏á PTTEP
    ‡πÅ‡∏•‡∏∞/‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô‡∏Å‡∏±‡∏ö‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£ (‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô) ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    """
    prompt = f"""
{PTT_CONTEXT}
{PTTEP_PROJECTS_CONTEXT}

[‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£ / ‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢]
- ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡πä‡∏≤‡∏ã‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏ä‡πà‡∏ô Chevron, ExxonMobil, TotalEnergies, Shell, BP, ENI,
  Sonatrach, Petrobras, ADNOC, Petronas ‡∏Ø‡∏•‡∏Ø
- ‡∏£‡∏±‡∏ê‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö PTTEP

‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: News Screener ‡∏Ç‡∏≠‡∏á PTTEP
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ß‡πà‡∏≤
‚Äú‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Å‡∏£‡∏∞‡∏ó‡∏ö **‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô** ‡πÉ‡∏ô **‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®** ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‚Äù

‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ ‚Äú‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ‡πÉ‡∏ä‡πà)‚Äù ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡πâ‡∏≠:
1) ‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πâ‡∏≤‡∏ô **‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô** (‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô, ‡∏Å‡πä‡∏≤‡∏ã, LNG, ‡∏ó‡πà‡∏≠‡∏™‡πà‡∏á, LNG terminal, FSRU, ‡πÅ‡∏ó‡πà‡∏ô‡∏ú‡∏•‡∏¥‡∏ï, upstream, midstream)
   ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÉ‡∏î ‡πÜ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡∏ï‡∏≤‡∏° [PTTEP_PROJECTS_CONTEXT]
   ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£‡∏Ç‡∏≠‡∏á PTTEP
2) ‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πâ‡∏≤‡∏ô **‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á / ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢ / ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ / ‡∏†‡∏≤‡∏©‡∏µ / ‡∏™‡∏±‡∏°‡∏õ‡∏ó‡∏≤‡∏ô / PSC / ‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏Ñ‡∏´‡∏•‡∏ß‡∏á / ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡πà‡∏≥‡∏ö‡∏≤‡∏ï‡∏£ /
   ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ß‡∏±‡∏ï‡∏¥, ‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á, ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•** ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP
   ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≠‡∏°
3) ‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πâ‡∏≤‡∏ô **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á, ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏†‡∏π‡∏°‡∏¥‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå, ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥, ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô**
   ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠ supply / ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà PTTEP ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà
4) ‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ/‡πÇ‡∏•‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏ô‡πâ‡∏ô‡∏ú‡∏•‡∏ï‡πà‡∏≠ **‡∏ï‡∏•‡∏≤‡∏î‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ‡∏Å‡πä‡∏≤‡∏ã LNG ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
   ‡∏ó‡∏µ‡πà PTTEP ‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£** ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ‚Äú‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‚Äù ‡πÄ‡∏°‡∏∑‡πà‡∏≠:
- ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á downstream, ‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î, retail, EV, ‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥, lifestyle, PR/CSR
  ‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö upstream ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô/‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
- ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô/‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÇ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏ô context

‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì ‚Äú‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‚Äù ‡πÅ‡∏ï‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP
‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏∏‡∏ô ‡πÉ‡∏´‡πâ **‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á ‚Äú‡πÉ‡∏ä‡πà‚Äù** (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô)

‡∏Ç‡πà‡∏≤‡∏ß:
‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: {news['title']}
‡∏™‡∏£‡∏∏‡∏õ: {news['summary']}
‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {news.get('detail','')}

‡∏ï‡∏≠‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°):
- ‡πÉ‡∏ä‡πà
- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà
"""

    try:
        r = call_gemini(prompt)
        ans = (r.text or "").strip().replace("\n", "")
        return ans.startswith("‡πÉ‡∏ä‡πà")
    except Exception:
        return False


# ============================================================================================================
# TAG ‡∏Ç‡πà‡∏≤‡∏ß (‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® / ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ + ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)
# ============================================================================================================
def gemini_tag(news):
    """
    ‡πÉ‡∏´‡πâ LLM ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß + ‡∏ï‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πà‡∏≤‡∏ß + ‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ + ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® + ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
    ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô '‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    """
    schema = {
        "type": "object",
        "properties": {
            "summary": {"type": "string"},
            "topic_type": {
                "type": "string",
                "enum": [
                    "supply_disruption",
                    "price_move",
                    "policy",
                    "investment",
                    "geopolitics",
                    "other",
                ],
            },
            "region": {
                "type": "string",
                "enum": ["global", "asia", "europe", "middle_east", "us", "other"],
            },
            "impact_reason": {"type": "string"},
            "country": {"type": "string"},
            "projects": {
                "type": "array",
                "items": {"type": "string"},
            },
        },
        "required": ["summary", "topic_type", "region", "impact_reason"],
    }

    prompt = f"""
{PTT_CONTEXT}
{PTTEP_PROJECTS_CONTEXT}

‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: Analyst ‡∏Ç‡∏≠‡∏á PTTEP
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏•‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏õ‡∏ï‡∏ó. ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°

‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡∏Ç‡πà‡∏≤‡∏ß:
‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: {news['title']}
‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å RSS: {news['summary']}
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: {news.get('detail','')}

‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤:
- summary:
  - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 2‚Äì4 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
  - (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô LINE)
- impact_reason:
  - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö bullet ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
    *‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô* ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP"
  - ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® / ‡∏ö‡∏•‡πá‡∏≠‡∏Å / ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å [PTTEP_PROJECTS_CONTEXT]
  - ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á" ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏ä‡πà‡∏ô
    ‚Ä¢ ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î

- country:
  - ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô Thailand, Myanmar, Vietnam, Mozambique, UAE ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
- projects:
  - ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô list
    ‡πÄ‡∏ä‡πà‡∏ô ["G1/61", "Arthit"], ["Zawtika"], ["Mozambique Area 1"], ["Ghasha"]
  - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ [] (array ‡∏ß‡πà‡∏≤‡∏á)

‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ï‡∏≤‡∏° schema ‡∏ô‡∏µ‡πâ:
{json.dumps(schema, ensure_ascii=False)}
"""

    try:
        r = call_gemini(prompt)
        raw = (r.text or "").strip()

        # ‡∏ï‡∏±‡∏î ``` ‡∏´‡∏£‡∏∑‡∏≠ ```json ‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if raw.startswith("```"):
            raw = re.sub(r"^```(json)?", "", raw).strip()
            raw = re.sub(r"```$", "", raw).strip()

        return json.loads(raw)
    except Exception:
        return {
            "summary": news["summary"],
            "topic_type": "other",
            "region": "other",
            "impact_reason": "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP",
        }


# ============================================================================================================
# FETCH NEWS
# ============================================================================================================
NEWS_FEEDS = [
    ("Oilprice", "Energy", "https://oilprice.com/rss/main"),
    ("CleanTechnica", "Energy", "https://cleantechnica.com/feed/"),
    ("HydrogenFuelNews", "Energy", "https://www.hydrogenfuelnews.com/feed/"),
    ("Economist", "Economy", "https://www.economist.com/latest/rss.xml"),
    ("YahooFinance", "Economy", "https://finance.yahoo.com/news/rssindex"),
]


def fetch_news_window():
    now_local = datetime.now(bangkok_tz)

    # ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 21:00 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ‡∏ñ‡∏∂‡∏á 06:00 ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    start = (now_local - timedelta(days=1)).replace(
        hour=21, minute=0, second=0, microsecond=0
    )
    end = now_local.replace(hour=6, minute=0, second=0, microsecond=0)

    out = []

    for site, cat, url in NEWS_FEEDS:
        try:
            feed = feedparser.parse(url)
            for e in feed.entries:
                pub = getattr(e, "published", None) or getattr(e, "updated", None)
                if not pub:
                    continue

                dt = dateutil_parser.parse(pub)
                if dt.tzinfo is None:
                    dt = pytz.UTC.localize(dt)
                dt = dt.astimezone(bangkok_tz)

                if start <= dt <= end:
                    out.append(
                        {
                            "site": site,
                            "category": cat,
                            "title": e.title,
                            "summary": getattr(e, "summary", ""),
                            "link": e.link,
                            "published": dt,
                            "date": dt.strftime("%d/%m/%Y %H:%M"),
                        }
                    )
        except Exception:
            pass

    # dedupe ‡∏ï‡∏≤‡∏° link
    uniq = []
    seen = set()
    for n in out:
        k = _normalize_link(n["link"])
        if k not in seen:
            seen.add(k)
            uniq.append(n)

    return uniq


# ============================================================================================================
# FLEX MESSAGE
# ============================================================================================================
def create_flex(news_items):
    now_txt = datetime.now(bangkok_tz).strftime("%d/%m/%Y")
    bubbles = []

    for n in news_items:
        bullets = _impact_to_bullets(n.get("impact_reason", "-"))

        link = n.get("link") or ""
        if not (isinstance(link, str) and link.startswith(("http://", "https://"))):
            link = "https://www.google.com/search?q=energy+gas+news"

        img = n.get("image") or DEFAULT_ICON_URL
        if not (isinstance(img, str) and img.startswith(("http://", "https://"))):
            img = DEFAULT_ICON_URL

        country_txt = (n.get("country") or "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏").strip()
        projects = n.get("projects") or []
        if isinstance(projects, list):
            proj_txt = ", ".join(projects[:3]) if projects else "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
        else:
            proj_txt = str(projects)

        body_contents = [
            {
                "type": "text",
                "text": n["title"],
                "weight": "bold",
                "size": "lg",
                "wrap": True,
            },
            {
                "type": "text",
                "text": f"üóì {n['date']}",
                "size": "xs",
                "color": "#888888",
                "margin": "sm",
            },
            {
                "type": "text",
                "text": f"üåç {n['site']}",
                "size": "xs",
                "color": "#448AFF",
                "margin": "xs",
            },
            {
                "type": "text",
                "text": f"‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: {proj_txt} | ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®: {country_txt}",
                "size": "xs",
                "color": "#555555",
                "margin": "sm",
                "wrap": True,
            },
        ]

        impact_box = {
            "type": "box",
            "layout": "vertical",
            "margin": "lg",
            "contents": [
                {
                    "type": "text",
                    "text": "‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
                    "size": "lg",
                    "weight": "bold",
                    "color": "#000000",
                }
            ]
            + [
                {
                    "type": "text",
                    "text": f"‚Ä¢ {b}",
                    "wrap": True,
                    "size": "md",
                    "color": "#000000",
                    "weight": "bold",
                    "margin": "xs",
                }
                for b in bullets
            ],
        }

        body_contents.append(impact_box)

        bubble = {
            "type": "bubble",
            "size": "mega",
            "hero": {
                "type": "image",
                "url": img,
                "size": "full",
                "aspectRatio": "16:9",
                "aspectMode": "cover",
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": body_contents,
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "style": "primary",
                        "color": "#1DB446",
                        "action": {
                            "type": "uri",
                            "label": "‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠",
                            "uri": link,
                        },
                    }
                ],
            },
        }

        bubbles.append(bubble)

    return [
        {
            "type": "flex",
            "altText": f"‡∏Ç‡πà‡∏≤‡∏ß PTTEP {now_txt}",
            "contents": {"type": "carousel", "contents": bubbles},
        }
    ]


# ============================================================================================================
# BROADCAST LINE
# ============================================================================================================
def send_to_line(messages):
    url = "https://api.line.me/v2/bot/message/broadcast"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {LINE_CHANNEL_ACCESS_TOKEN}",
    }

    for i, msg in enumerate(messages, 1):
        payload = {"messages": [msg]}

        print("=== LINE PAYLOAD ===")
        print(json.dumps(payload, ensure_ascii=False, indent=2))

        if DRY_RUN:
            print("[DRY_RUN] ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ DRY_RUN = true")
            continue

        r = S.post(url, headers=headers, json=payload, timeout=15)
        print(f"Send {i}: {r.status_code}")
        print("Response body:", r.text)

        if r.status_code >= 300:
            break


# ============================================================================================================
# MAIN WORKFLOW
# ============================================================================================================
def main():
    print("‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß...")
    all_news_raw = fetch_news_window()
    print("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:", len(all_news_raw))

    # ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ keyword filter ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ llm_filter
    all_news = all_news_raw

    filtered = []
    for n in all_news:
        n["detail"] = n["title"] if len(n["summary"]) < 50 else ""
        if llm_filter(n):
            filtered.append(n)
        time.sleep(random.uniform(*SLEEP_BETWEEN_CALLS))

    print("‡∏ú‡πà‡∏≤‡∏ô llm_filter:", len(filtered))

    if not filtered:
        print("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏ï‡∏≤‡∏° llm_filter)")
        return

    print("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢ LLM (tag + impact)...")
    tagged = []
    for n in filtered:
        tag = gemini_tag(n)

        n["topic_type"] = tag.get("topic_type", "other")
        n["region"] = tag.get("region", "other")
        n["impact_reason"] = tag.get(
            "impact_reason", "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á PTTEP"
        )
        n["summary_llm"] = (
            tag.get("summary")
            or n.get("summary")
            or n["title"]
        )
        n["country"] = tag.get("country", "")
        n["projects"] = tag.get("projects", [])

        # ‡∏ñ‡πâ‡∏≤ impact ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏£‡∏∞ (‡πÅ‡∏Ñ‡πà‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö...") ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
        if not has_meaningful_impact(n["impact_reason"]):
            continue

        tagged.append(n)
        time.sleep(random.uniform(*SLEEP_BETWEEN_CALLS))

    print("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á ‡πÜ:", len(tagged))
    if not tagged:
        print("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô")
        return

    selected = tagged[:10]

    sent = load_sent_links()
    final = [n for n in selected if _normalize_link(n["link"]) not in sent]
    print("‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤:", len(final))

    if not final:
        print("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà")
        return

    for n in final:
        img = fetch_article_image(n.get("link", ""))
        if not (isinstance(img, str) and img.startswith(("http://", "https://"))):
            img = DEFAULT_ICON_URL
        n["image"] = img
        time.sleep(0.5)

    msgs = create_flex(final)
    send_to_line(msgs)
    save_sent_links([n["link"] for n in final])

    print("‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô")


# ============================================================================================================
if __name__ == "__main__":
    main()
