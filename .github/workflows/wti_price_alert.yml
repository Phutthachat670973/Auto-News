name: WTI Price Alert Monitor (Real-time)

on:
  schedule:
    # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ (48 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô) - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡πÜ
    - cron: "*/30 * * * *"
    
    # ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å 15 ‡∏ô‡∏≤‡∏ó‡∏µ (96 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô) - ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ real-time ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
    # - cron: "*/15 * * * *"
    
    # ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (24 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô) - ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î
    # - cron: "0 * * * *"
  
  workflow_dispatch:  # ‡∏£‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Manual ‡πÑ‡∏î‡πâ
    inputs:
      test_mode:
        description: 'Test mode (send alert regardless of price)'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  check-price-and-alert:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dateutil pytz python-dotenv
      
      - name: Check WTI Price and Send Alert
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
          
          # Alert Configuration
          WTI_ALERT_ENABLED: "1"
          WTI_ALERT_THRESHOLD: "60.0"
          
          # Test mode
          TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
          
          TZ: "Asia/Bangkok"
          
        run: |
          python scripts/check_wti_alert.py
      
      - name: Commit alert history
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add alert history
          git add config/alert_settings.json || true
          
          # Commit with timestamp
          git commit -m "üîî Alert check - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes"
          
          # Push changes
          git push || echo "Push skipped"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: alert-logs-${{ github.run_number }}
          path: |
            *.log
            config/alert_settings.json
          retention-days: 3
